<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œë¦¬ ì—¬í–‰ í”„ë¡œê·¸ë¨ ì„ í˜¸ë„ ì¡°ì‚¬</title>

    <!-- ì†Œì…œ ê³µìœ ë¥¼ ìœ„í•œ Open Graph ë©”íƒ€ íƒœê·¸ -->
    <meta property="og:title" content="âœ¨ ë°œë¦¬ì—ì„œ ìƒê¸¸ ì¼ âœ¨">
    <meta property="og:description" content="â˜… ë°œë¦¬ ì—¬í–‰ ìµœê³ ì˜ í”„ë¡œê·¸ë¨ì„ ë½‘ì•„ì£¼ì„¸ìš” â˜…">
    <meta property="og:image" content="https://github.com/incarmarketing/bali-vote-project/blob/main/thumbnail.jpg?raw=true">
    <meta property="og:url" content="https://incarmarketing.github.io/bali-vote-project/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <style>
        /* ì¼ë°˜ ìŠ¤íƒ€ì¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1537953773345-d172ccf13cf1?q=80&w=1935&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
            background-size: cover; background-position: center; background-attachment: fixed;
            min-height: 100vh;
        }
        
        /* ì¸íŠ¸ë¡œ ì˜ìƒ ìŠ¤í”Œë˜ì‹œ í™”ë©´ */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 1s ease-out;
        }
        #intro-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center; /* ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ì¤‘ì•™ ì •ë ¬ */
        }
        #skip-intro {
            position: absolute; bottom: 30px; right: 30px;
            background-color: rgba(0, 0, 0, 0.7); color: white;
            border: 1px solid white; padding: 10px 20px;
            border-radius: 20px; cursor: pointer; font-size: 14px; z-index: 10001;
        }
        
        /* ë©”ì¸ ì½˜í…ì¸  ë˜í¼ */
        .main-wrapper {
            padding: 20px; opacity: 0; /* ì²˜ìŒì—ëŠ” ìˆ¨ê¹€ */
            transition: opacity 1s ease-in;
        }
        .main-wrapper.visible { opacity: 1; }

        .logo-container { text-align: center; margin-bottom: 20px; }
        .company-logo { max-height: 60px; }
        
        /* ìŒì•… í† ê¸€ ë²„íŠ¼ */
        #music-toggle {
            position: fixed; bottom: 20px; left: 20px;
            background-color: rgba(0, 0, 0, 0.5); color: white;
            border: 1px solid white; width: 50px; height: 50px;
            border-radius: 50%; font-size: 24px; cursor: pointer;
            z-index: 1000; display: flex; justify-content: center; align-items: center;
        }

        /* í•µì‹¬ ë ˆì´ì•„ì›ƒ */
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, rgba(255,107,107,0.8), rgba(255,167,38,0.8)), url('https://images.unsplash.com/photo-1636619306699-2d27a100605e?q=80&w=1170&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); background-size: cover; background-position: center; color: white; padding: 40px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .main-content { padding: 40px; padding-bottom: 100px; }
        
        /* ê´€ë¦¬ì íŒ¨ë„ */
        .admin-panel { background: #f8f9fa; border-radius: 15px; padding: 30px; margin-bottom: 40px; border: 2px dashed #dee2e6; display: none; }
        .admin-panel.show { display: block; }
        .admin-toggle { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 15px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; transition: all 0.3s; }
        .admin-toggle:hover { transform: scale(1.1); }
        .admin-toggle:disabled {
            background: linear-gradient(135deg, #9E9E9E, #757575);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .admin-toggle:disabled:hover { transform: none; }
        .admin-toggle.failed { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .admin-panel h2 { color: #495057; margin-bottom: 20px; font-size: 1.5em; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        
        /* ë²„íŠ¼ */
        .btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-right: 10px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d, #495057); }
        
        /* í”„ë¡œê·¸ë¨ ì¹´ë“œ */
        .programs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-top: 30px; }
        .program-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; position: relative; }
        .program-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .program-image { width: 100%; height: 200px; object-fit: cover; }
        .program-content { padding: 25px; }
        .program-title { font-size: 1.3em; font-weight: 700; margin-bottom: 10px; color: #2c3e50; }
        .program-description { color: #7f8c8d; line-height: 1.6; margin-bottom: 20px; min-height: 75px; }
        .vote-section { display: flex; align-items: center; justify-content: space-between; padding-top: 20px; border-top: 1px solid #ecf0f1; }
        .vote-btn { background: linear-gradient(135deg, #00b894, #00cec9); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .vote-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3); }
        .vote-count { font-weight: 700; color: #2c3e50; font-size: 1.1em; }
        .admin-controls { display: none; gap: 10px; margin-top: 15px; }
        .admin-controls.show { display: flex; }

        /* ê²°ê³¼ ì„¹ì…˜ */
        .results-section { background: #f8f9fa; border-radius: 15px; padding: 30px; margin-top: 40px; }
        .results-header { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; position: relative; }
        .results-header h2 { color: #2c3e50; margin: 0; }
        .excel-download-btn { position: absolute; right: 0; background: linear-gradient(135deg, #28a745, #218838); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 14px; cursor: pointer; display: none; }
        .excel-download-btn.show { display: inline-block; }
        .no-programs { text-align: center; color: #7f8c8d; font-size: 1.1em; padding: 40px; }
        
        /* ëª¨ë‹¬ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%; text-align: center; animation: modal-appear 0.3s ease-out; }
        @keyframes modal-appear { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-content h3 { margin-bottom: 20px; color: #2c3e50; }
        .modal-content p { margin-bottom: 20px; color: #495057; line-height: 1.6; }
        .modal-content input { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; margin-bottom: 20px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        
        /* íˆ¬í‘œì ëª©ë¡ ëª¨ë‹¬ */
        .view-voters-btn { background: #6c757d; color: white; border: none; padding: 5px 10px; font-size: 12px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #voterList { list-style: none; text-align: left; max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; }
        #voterList li { padding: 8px; border-bottom: 1px solid #eee; }
        #voterList li:last-child { border-bottom: none; }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .main-wrapper { padding: 10px; }
            .header { padding: 30px 20px; }
            .header h1 { font-size: 2em; }
            .main-content { padding: 20px; padding-bottom: 100px; }
            .programs-grid { grid-template-columns: 1fr; }
            .results-header { flex-direction: column; gap: 15px; }
            .excel-download-btn { position: static; }
            #intro-video {
                object-position: 75% 50%;
            }
        }
    </style>
</head>
<body>
    <!-- ìŠ¤í”Œë˜ì‹œ í™”ë©´ -->
    <div id="splash-screen">
        <video id="intro-video" src="https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/intro.mp4" autoplay muted playsinline></video>
        <button id="skip-intro">ì¸íŠ¸ë¡œ ê±´ë„ˆë›°ê¸° &gt;</button>
    </div>

    <!-- ë°°ê²½ ìŒì•… -->
    <audio id="background-music" src="https://cdn.pixabay.com/download/audio/2022/08/27/audio_2932470728.mp3" loop></audio>
    <button id="music-toggle">ğŸ”‡</button>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-wrapper">
        <div class="logo-container">
            <img src="https://github.com/incarmarketing/bali-vote-project/blob/main/logo.png?raw=true" alt="íšŒì‚¬ ë¡œê³ " class="company-logo" onerror="this.style.display='none'">
        </div>

        <div class="container">
            <div class="header">
                <h1>âœ¨ ë°œë¦¬ì—ì„œ ìƒê¸¸ ì¼ âœ¨</h1>
                <p>í•¨ê»˜ ë– ë‚  ë°œë¦¬ ì—¬í–‰<br>ìµœê³ ì˜ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”!</p>
            </div>
            <div class="main-content">
                <!-- ê´€ë¦¬ì íŒ¨ë„ -->
                <div class="admin-panel" id="adminPanel">
                    <h2>âœ¨ í”„ë¡œê·¸ë¨ ì¶”ê°€/í¸ì§‘</h2>
                    <form id="programForm">
                        <div class="form-group"><label for="programTitle">í”„ë¡œê·¸ë¨ ì´ë¦„</label><input type="text" id="programTitle" placeholder="ì˜ˆ: ìš°ë¶“ ë¼ì´ìŠ¤ í…Œë¼ìŠ¤ íˆ¬ì–´" required></div>
                        <div class="form-group"><label for="programDescription">í”„ë¡œê·¸ë¨ ì„¤ëª…</label><textarea id="programDescription" placeholder="í”„ë¡œê·¸ë¨ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..." required></textarea></div>
                        <div class="form-group"><label for="programImage">ì´ë¯¸ì§€ URL (ì„ íƒì‚¬í•­)</label><input type="url" id="programImage" placeholder="https://example.com/image.jpg"></div>
                        <button type="submit" class="btn">í”„ë¡œê·¸ë¨ ì¶”ê°€</button>
                        <button type="button" class="btn btn-danger" id="clearFormBtn">ì…ë ¥ ì´ˆê¸°í™”</button>
                    </form>
                    <hr style="margin: 30px 0; border: 1px solid #eee;">
                    <h2 style="color: #495057;">âœ¨ ë°ì´í„° ê´€ë¦¬</h2>
                    <button type="button" class="btn" id="addDefaultsBtn">ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€</button>
                    <p style="font-size: 14px; color: #7f8c8d; margin-top: 10px; margin-bottom: 20px;">
                        í˜„ì¬ ëª©ë¡ì— ì—†ëŠ” ê¸°ë³¸ í”„ë¡œê·¸ë¨ì„ ì¶”ê°€í•©ë‹ˆë‹¤. ê¸°ì¡´ ë°ì´í„°ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </p>
                    <h2 style="color: #c0392b;">ğŸš¨ ìœ„í—˜ êµ¬ì—­ ğŸš¨</h2>
                    <button type="button" class="btn btn-danger" id="initDbBtn">DB ì´ˆê¸°í™” ë° ê¸°ë³¸ê°’ ì„¤ì •</button>
                    <p style="font-size: 14px; color: #7f8c8d; margin-top: 10px;">
                        ì£¼ì˜: ì´ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ DBì˜ ëª¨ë“  í”„ë¡œê·¸ë¨ì´ ì‚­ì œë˜ê³ , ì½”ë“œì— ì •ì˜ëœ ê¸°ë³¸ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ë®ì–´ì”ë‹ˆë‹¤.
                    </p>
                </div>
                
                <!-- í”„ë¡œê·¸ë¨ ì¹´ë“œ -->
                <div class="programs-grid" id="programsGrid"></div>
                <div class="no-programs" id="noPrograms">í”„ë¡œê·¸ë¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                
                <!-- ê²°ê³¼ ì„¹ì…˜ -->
                <div class="results-section">
                    <div class="results-header">
                        <h2>ğŸ“Š ì‹¤ì‹œê°„ íˆ¬í‘œ ê²°ê³¼</h2>
                        <button id="excelDownloadBtn" class="excel-download-btn">ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                    <div id="resultsChart"></div>
                </div>
            </div>
            <button class="admin-toggle" id="adminToggleBtn" title="ì´ˆê¸°í™” ì¤‘..." disabled>ğŸ”§</button>
        </div>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h3>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
            <p style="font-size:14px; color:#7f8c8d;">Firebase ì½˜ì†”ì—ì„œ ìƒì„±í•œ<br>ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
            <input type="email" id="adminEmail" placeholder="ê´€ë¦¬ì ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
            <input type="password" id="adminPassword" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <div class="modal-buttons">
                <button class="btn" id="loginBtn">ë¡œê·¸ì¸</button>
                <button class="btn btn-danger" onclick="hideModal('passwordModal')">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    <div class="modal" id="voterAuthModal">
        <div class="modal-content">
            <h3>ğŸ—³ï¸ íˆ¬í‘œì ì •ë³´ ì…ë ¥</h3>
            <input type="text" id="voterEmployeeId" placeholder="ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”">
            <input type="text" id="voterName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <div class="modal-buttons">
                <button class="btn" id="submitVoteBtn">íˆ¬í‘œí•˜ê¸°</button>
                <button class="btn btn-danger" onclick="hideModal('voterAuthModal')">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    <div class="modal" id="voterListModal">
        <div class="modal-content">
            <h3 id="voterListTitle">íˆ¬í‘œì ëª…ë‹¨</h3>
            <ul id="voterList"></ul>
            <div class="modal-buttons" style="margin-top: 20px;"><button class="btn btn-danger" onclick="hideModal('voterListModal')">ë‹«ê¸°</button></div>
        </div>
    </div>
    <!-- ì¼ë°˜ ì•Œë¦¼/í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal" id="alertModal">
        <div class="modal-content">
            <h3 id="alertTitle">ì•Œë¦¼</h3>
            <p id="alertMessage"></p>
            <div class="modal-buttons">
                <button class="btn" id="alertOkBtn">í™•ì¸</button>
                <button class="btn btn-secondary" id="alertCancelBtn" style="display:none;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase ëª¨ë“ˆ ê°€ì ¸ì˜¤ê¸° (ìµœì‹  ë²„ì „ìœ¼ë¡œ í†µì¼)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, increment, arrayUnion, onSnapshot, writeBatch, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ---
        let db, auth;
        let programs = [];
        let editingId = null;
        let votingForId = null;
        let isAdminMode = false;
        let unsubscribePrograms = null; // ë¦¬ìŠ¤ë„ˆ êµ¬ë… í•´ì œ í•¨ìˆ˜ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•¨

        // --- DOM ìš”ì†Œ ---
        const splashScreen = document.getElementById('splash-screen');
        const introVideo = document.getElementById('intro-video');
        const mainWrapper = document.querySelector('.main-wrapper');
        const music = document.getElementById('background-music');
        const programsGrid = document.getElementById('programsGrid');
        const noProgramsEl = document.getElementById('noPrograms');
        const programForm = document.getElementById('programForm');
        const adminToggleBtn = document.getElementById('adminToggleBtn');

        // --- ëª¨ë‹¬ ë„ìš°ë¯¸ í•¨ìˆ˜ ---
        window.showModal = (id) => document.getElementById(id).classList.add('show');
        window.hideModal = (id) => document.getElementById(id).classList.remove('show');

        // --- ì»¤ìŠ¤í…€ ì•Œë¦¼/í™•ì¸ ì°½ ---
        const showAlert = (message, title = 'ì•Œë¦¼', onOk) => {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').innerHTML = message;
            const okBtn = document.getElementById('alertOkBtn');
            const cancelBtn = document.getElementById('alertCancelBtn');
            cancelBtn.style.display = 'none';
            
            okBtn.onclick = () => {
                hideModal('alertModal');
                if (onOk) onOk();
            };
            showModal('alertModal');
        };

        const showConfirm = (message, title = 'í™•ì¸ í•„ìš”') => {
            return new Promise((resolve) => {
                document.getElementById('alertTitle').textContent = title;
                document.getElementById('alertMessage').innerHTML = message;
                const okBtn = document.getElementById('alertOkBtn');
                const cancelBtn = document.getElementById('alertCancelBtn');
                cancelBtn.style.display = 'inline-block';

                okBtn.onclick = () => { hideModal('alertModal'); resolve(true); };
                cancelBtn.onclick = () => { hideModal('alertModal'); resolve(false); };
                showModal('alertModal');
            });
        };

        // --- ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
            playIntroVideo();
            playMusic();
        });

        async function initializeFirebase() {
            try {
                // =======================================================================
                // [ì¤‘ìš”] ê¹ƒí—ˆë¸Œ ë°°í¬ ì‹œ ì´ ë¶€ë¶„ì„ ìì‹ ì˜ Firebase í”„ë¡œì íŠ¸ ì •ë³´ë¡œ êµì²´í•˜ì„¸ìš”!
                // Firebase ì½˜ì†” > í”„ë¡œì íŠ¸ ì„¤ì • > ì¼ë°˜ > ë‚´ ì•± > SDK ì„¤ì • ë° êµ¬ì„±
                // 'êµ¬ì„±(config)' ì˜µì…˜ì„ ì„ íƒí•˜ì—¬ ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.
                // =======================================================================
                const firebaseConfig = {
                  apiKey: "YOUR_API_KEY",
                  authDomain: "YOUR_AUTH_DOMAIN",
                  projectId: "YOUR_PROJECT_ID",
                  storageBucket: "YOUR_STORAGE_BUCKET",
                  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                  appId: "YOUR_APP_ID"
                };

                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    throw new Error("Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ì—ì„œ firebaseConfig ë³€ìˆ˜ë¥¼ ìì‹ ì˜ í”„ë¡œì íŠ¸ ì •ë³´ë¡œ êµì²´í•´ì£¼ì„¸ìš”.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                adminToggleBtn.disabled = false;
                adminToggleBtn.title = 'ê´€ë¦¬ì ëª¨ë“œ';
                console.log("Firebase is ready. Admin functions are now available.");

                // [ìˆ˜ì •ë¨] ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ ë³€í™” ê°ì§€ ë¡œì§ ê°•í™”
                onAuthStateChanged(auth, user => {
                    // ì‚¬ìš©ìê°€ ìˆê³ , ìµëª…ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê´€ë¦¬ìë¡œ ê°„ì£¼
                    if (user && !user.isAnonymous) {
                        console.log("ê´€ë¦¬ìë¡œ ì¸ì¦ë¨:", user.uid);
                        isAdminMode = true;
                        document.getElementById('adminPanel').classList.add('show');
                        document.getElementById('excelDownloadBtn').classList.add('show');
                    } else {
                        // ê·¸ ì™¸ ëª¨ë“  ê²½ìš°(ìµëª… ì‚¬ìš©ì, ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ë“±)ëŠ” ê´€ë¦¬ìê°€ ì•„ë‹˜
                        console.log("ê´€ë¦¬ì ì•„ë‹˜ (ìµëª… ë˜ëŠ” ë¡œê·¸ì•„ì›ƒ):", user ? user.uid : 'ì—†ìŒ');
                        isAdminMode = false;
                        document.getElementById('adminPanel').classList.remove('show');
                        document.getElementById('excelDownloadBtn').classList.remove('show');
                    }
                    // ëª¨ë“  ê²½ìš°ì— UIë¥¼ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ê´€ë¦¬ì ë²„íŠ¼ ë“±ì„ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œ
                    renderPrograms();
                    updateResults();
                });
                
                await signInAnonymously(auth);
                
                loadAndListenPrograms();

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                showAlert(`Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. <br><br><b>ì˜¤ë¥˜: ${error.message}</b><br><br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•˜ì‹œê±°ë‚˜, ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`, "ì¹˜ëª…ì  ì˜¤ë¥˜");
                
                adminToggleBtn.disabled = true;
                adminToggleBtn.title = 'ì´ˆê¸°í™” ì‹¤íŒ¨! ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.';
                adminToggleBtn.classList.add('failed');
                adminToggleBtn.innerHTML = 'âŒ';
            }
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        function setupEventListeners() {
            document.getElementById('skip-intro').onclick = showMainContent;
            introVideo.onended = showMainContent;
            
            introVideo.addEventListener('error', (e) => {
                console.error("ë¹„ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜:", e);
                showMainContent();
            });

            document.getElementById('music-toggle').addEventListener('click', toggleMusic);
            adminToggleBtn.onclick = () => showModal('passwordModal');
            document.getElementById('loginBtn').onclick = checkAdminPassword;
            document.getElementById('clearFormBtn').onclick = clearForm;
            document.getElementById('initDbBtn').onclick = runInitialization;
            document.getElementById('addDefaultsBtn').onclick = addDefaultPrograms;
            document.getElementById('submitVoteBtn').onclick = submitVote;
            document.getElementById('excelDownloadBtn').onclick = exportToExcel;
            programForm.addEventListener('submit', handleFormSubmit);
        }

        // --- ì¸íŠ¸ë¡œ ë° ìŒì•… ê´€ë ¨ ---
        function playIntroVideo() {
            const playPromise = introVideo.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.warn("ì˜ìƒ ìë™ ì¬ìƒ ì‹¤íŒ¨. ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.", error);
                    splashScreen.addEventListener('click', () => introVideo.play(), { once: true });
                });
            }
        }
        
        function playMusic() {
            music.muted = true;
            music.play().catch(() => {
                console.warn('ìŒì•… ì¬ìƒì„ ìœ„í•´ ì‚¬ìš©ìì˜ ìƒí˜¸ì‘ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                document.body.addEventListener('click', () => {
                    if (music.paused) music.play();
                }, { once: true });
            });
        }

        function showMainContent() {
            if (splashScreen.style.display === 'none') return;
            splashScreen.style.opacity = '0';
            setTimeout(() => {
                splashScreen.style.display = 'none';
                mainWrapper.classList.add('visible');
                const musicToggle = document.getElementById('music-toggle');
                if (musicToggle.textContent === 'ğŸ”Š') {
                    music.muted = false;
                }
            }, 1000);
        }
        
        function toggleMusic() {
            music.muted = !music.muted;
            document.getElementById('music-toggle').textContent = music.muted ? 'ğŸ”‡' : 'ğŸ”Š';
        }

        // --- í•µì‹¬ ì•± ë¡œì§ ---
        function loadAndListenPrograms() {
            if (!db) {
                console.error("Firestore DBê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                noProgramsEl.textContent = 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.';
                return;
            }
            const programsCollectionRef = collection(db, "programs");
            
            if (unsubscribePrograms) unsubscribePrograms();

            unsubscribePrograms = onSnapshot(query(programsCollectionRef), (querySnapshot) => {
                programs = [];
                if (querySnapshot.empty) {
                    noProgramsEl.textContent = 'í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•˜ì—¬ DBë¥¼ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”.';
                } else {
                    querySnapshot.forEach((doc) => {
                        programs.push({ id: doc.id, ...doc.data() });
                    });
                    programs.sort((a, b) => (a.order || 0) - (b.order || 0));
                }
                renderPrograms();
                updateResults();
            }, (error) => {
                console.error("ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜:", error);
                showAlert(`ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. <br><br>ì˜¤ë¥˜: ${error.message}`, "ë°ì´í„° ì˜¤ë¥˜");
                noProgramsEl.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            });
        }

        function renderPrograms() {
            if (!programsGrid) return;
            if (!programs || programs.length === 0) {
                programsGrid.style.display = 'none';
                noProgramsEl.style.display = 'block';
                return;
            }
            programsGrid.style.display = 'grid';
            noProgramsEl.style.display = 'none';

            programsGrid.innerHTML = programs.map(p => `
                <div class="program-card">
                    <img src="${p.image || 'https://placehold.co/400x200/png?text=ì´ë¯¸ì§€+ì—†ìŒ'}" alt="${p.title}" class="program-image" onerror="this.onerror=null; this.src='https://placehold.co/400x200/png?text=ì´ë¯¸ì§€+ì˜¤ë¥˜';">
                    <div class="program-content">
                        <h3 class="program-title">${p.title}</h3>
                        <p class="program-description">${p.description}</p>
                        <div class="vote-section">
                            <button class="vote-btn" onclick="requestVote('${p.id}')">ğŸ‘ ì´ í”„ë¡œê·¸ë¨ ì„ íƒ</button>
                            <span class="vote-count">${p.votes || 0}í‘œ</span>
                        </div>
                        <div class="admin-controls ${isAdminMode ? 'show' : ''}">
                            <button class="btn" onclick="editProgram('${p.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-danger" onclick="deleteProgram('${p.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateResults() {
            const resultsChart = document.getElementById('resultsChart');
            if (!resultsChart) return;
            if (!programs || programs.length === 0) {
                resultsChart.innerHTML = '<div class="no-programs">íˆ¬í‘œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>';
                return;
            }
            const totalVotes = programs.reduce((sum, p) => sum + (p.votes || 0), 0);
            
            resultsChart.innerHTML = `
                <div style="margin-bottom: 20px; text-align: center;"><strong>ì´ íˆ¬í‘œ ìˆ˜: ${totalVotes}í‘œ</strong></div>
                ${programs.map(p => {
                    const percentage = totalVotes > 0 ? ((p.votes || 0) / totalVotes * 100).toFixed(1) : 0;
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div>
                                    <span style="font-weight: 600;">${p.title}</span>
                                    ${isAdminMode ? `<button class="view-voters-btn" onclick="showVoters('${p.id}')">íˆ¬í‘œì ë³´ê¸°</button>` : ''}
                                </div>
                                <span style="color: #7f8c8d;">${p.votes || 0}í‘œ (${percentage}%)</span>
                            </div>
                            <div style="background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${percentage}%; transition: width 0.5s ease-in-out;"></div>
                            </div>
                        </div>`;
                }).join('')}
            `;
        }

        // --- íˆ¬í‘œ ë¡œì§ ---
        window.requestVote = (id) => {
            if (!db) return showAlert('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            votingForId = id;
            showModal('voterAuthModal');
            document.getElementById('voterEmployeeId').focus();
        };

        async function submitVote() {
            if (!db) return showAlert('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            const employeeId = document.getElementById('voterEmployeeId').value.trim();
            const name = document.getElementById('voterName').value.trim();
            if (!employeeId || !name) {
                return showAlert('ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
            
            const alreadyVoted = programs.some(p => p.voters?.some(v => v.id === employeeId));
            if (alreadyVoted) {
                hideModal('voterAuthModal');
                return showAlert('ì´ë¯¸ ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì— íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤. í•œ ì‚¬ëŒë‹¹ í•œ ë²ˆë§Œ íˆ¬í‘œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            
            try {
                const programRef = doc(db, "programs", votingForId);
                await updateDoc(programRef, { 
                    votes: increment(1), 
                    voters: arrayUnion({ id: employeeId, name: name }) 
                });
                
                hideModal('voterAuthModal');
                document.getElementById('voterEmployeeId').value = '';
                document.getElementById('voterName').value = '';
                showAlert('íˆ¬í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'íˆ¬í‘œ ì™„ë£Œ');
            } catch (error) {
                console.error("íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜:", error);
                showAlert(`íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. <br><br>ì˜¤ë¥˜: ${error.message}`, "ì˜¤ë¥˜");
            }
        }

        // --- ê´€ë¦¬ì ë¡œì§ ---
        async function checkAdminPassword() {
            if (!auth) return showAlert('Firebase ì¸ì¦ ì„œë¹„ìŠ¤ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ì´ˆê¸°í™” ì¤‘');

            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            if (!email || !password) return showAlert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideModal('passwordModal');
                showAlert('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ! ğŸ”“');
            } catch (error) {
                console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨ ìƒì„¸ ì •ë³´:", error);
                let errorDetails = `<b>ì˜¤ë¥˜ ì½”ë“œ:</b> ${error.code || 'ì •ì˜ë˜ì§€ ì•ŠìŒ'}<br><b>ì˜¤ë¥˜ ë©”ì‹œì§€:</b> ${error.message || 'ë©”ì‹œì§€ ì—†ìŒ'}`;
                showAlert(`ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì—¬ ì›ì¸ì„ íŒŒì•…í•´ì£¼ì„¸ìš”.<br><br>${errorDetails}`, 'ë¡œê·¸ì¸ ì˜¤ë¥˜');
            } finally {
                document.getElementById('adminPassword').value = '';
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!isAdminMode || !db) return showAlert('ê´€ë¦¬ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ê±°ë‚˜, ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            
            const title = document.getElementById('programTitle').value.trim();
            const description = document.getElementById('programDescription').value.trim();
            const image = document.getElementById('programImage').value.trim();
            if (!title || !description) return showAlert('í”„ë¡œê·¸ë¨ ì´ë¦„ê³¼ ì„¤ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            const programsCollectionRef = collection(db, "programs");
            const data = { title, description, image };

            try {
                if (editingId) {
                    await updateDoc(doc(programsCollectionRef, editingId), data);
                    showAlert('í”„ë¡œê·¸ë¨ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    const maxOrder = programs.reduce((max, p) => Math.max(max, p.order || 0), 0);
                    await addDoc(programsCollectionRef, { ...data, votes: 0, voters: [], order: maxOrder + 1 });
                    showAlert('ìƒˆë¡œìš´ í”„ë¡œê·¸ë¨ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                clearForm();
            } catch (error) {
                console.error("í”„ë¡œê·¸ë¨ ì¶”ê°€/ìˆ˜ì • ì˜¤ë¥˜:", error);
                showAlert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>(ì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message})`);
            }
        }
        
        function clearForm() {
            programForm.reset();
            editingId = null;
            document.querySelector('#programForm button[type="submit"]').textContent = 'í”„ë¡œê·¸ë¨ ì¶”ê°€';
        }

        window.editProgram = (id) => {
            if (!isAdminMode) return;
            const p = programs.find(prog => prog.id === id);
            if (p) {
                document.getElementById('programTitle').value = p.title;
                document.getElementById('programDescription').value = p.description.replace(/<br\s*\/?>/gi, '\n');
                document.getElementById('programImage').value = p.image || '';
                editingId = id;
                document.querySelector('#programForm button[type="submit"]').textContent = 'í”„ë¡œê·¸ë¨ ìˆ˜ì •';
                document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
            }
        };

        window.deleteProgram = async (id) => {
            if (!isAdminMode || !db) return;
            const confirmed = await showConfirm('ì •ë§ë¡œ ì´ í”„ë¡œê·¸ë¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? íˆ¬í‘œ ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.', 'ì‚­ì œ í™•ì¸');
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "programs", id));
                    showAlert('í”„ë¡œê·¸ë¨ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
                    showAlert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            }
        };
        
        window.showVoters = (id) => { 
            if (!isAdminMode) return;
            const p = programs.find(p => p.id === id); 
            if (!p) return; 
            const voterListEl = document.getElementById('voterList'); 
            document.getElementById('voterListTitle').textContent = `[${p.title}] íˆ¬í‘œì ëª…ë‹¨`; 
            const voters = p.voters || []; 
            voterListEl.innerHTML = voters.length ? voters.map(v => `<li>${v.name} (${v.id})</li>`).join('') : '<li>ì•„ì§ íˆ¬í‘œí•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</li>'; 
            showModal('voterListModal'); 
        };

        async function runInitialization() {
            if (!isAdminMode || !db) return showAlert('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•´ì•¼ í•˜ê±°ë‚˜, ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            
            const confirmed = await showConfirm("ğŸš¨ì •ë§ë¡œ ëª¨ë“  íˆ¬í‘œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ê¸°ë³¸ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!", "DB ì´ˆê¸°í™” í™•ì¸");
            if (!confirmed) return showAlert('ì´ˆê¸°í™”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');

            try {
                showAlert('DB ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...');
                const programsCollectionRef = collection(db, "programs");
                
                const oldDocsSnapshot = await getDocs(query(programsCollectionRef));
                const deleteBatch = writeBatch(db);
                oldDocsSnapshot.forEach(doc => deleteBatch.delete(doc.ref));
                await deleteBatch.commit();
                
                const defaultPrograms = [
                    { order: 1, title: 'ğŸš£ ìš°ë¶“ + ë˜í”„íŒ…', description: 'ì•„ìœµê°•ì—ì„œ ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ë˜í”„íŒ…ì„ ì¦ê¸°ê³ <br>ìš°ë¶“ ì™•ê¶ê³¼ ì „í†µì‹œì¥, ë§ˆì„ì„<br>ë‘˜ëŸ¬ë³´ëŠ” ì½”ìŠ¤ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1624646580989-9f059e25eb78?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 2, title: 'ğŸŒ¿ ìš°ë¶“ + ìŠ¤íŒŒ', description: 'ìš°ë¶“ì˜ ì™•ê¶ê³¼ ì „í†µì‹œì¥, ë§ˆì„ì„ ë‘˜ëŸ¬ë³´ê³ <br>ë°œë¦¬ ì „í†µ ë§ˆì‚¬ì§€ë¥¼ ë°›ìœ¼ë©°<br>ì‹¬ì‹ ì˜ í”¼ë¡œë¥¼ í‘¸ëŠ” íë§ ì½”ìŠ¤ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1708436137498-1b660e94c782?q=80&w=687&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 3, title: 'ğŸ–ï¸ ë¦¬ì¡°íŠ¸ ììœ ì‹œê°„', description: 'ê³ ê¸‰ ë¦¬ì¡°íŠ¸ì˜ ìˆ˜ì˜ì¥ê³¼ ë¶€ëŒ€ì‹œì„¤ì„<br>ë§ˆìŒê» ì´ìš©í•˜ë©° ëˆ„êµ¬ì˜ ë°©í•´ë„ ë°›ì§€ ì•ŠëŠ”<br>ì™„ë²½í•œ ììœ ì‹œê°„ì„ ë§Œë½í•©ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1596178065887-1198b6148b2b?ixlib-rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80' },
                    { order: 4, title: 'ğŸŒï¸â€â™‚ï¸ ê³¨í”„', description: 'ë°œë¦¬ ë‰´ ê¾¸íƒ€ ê³¨í”„ í´ëŸ½ì—ì„œ<br>í™˜ìƒì ì¸ í•´ì•ˆì ˆê²½ì„ ê°ìƒí•˜ë©°<br>ë¼ìš´ë”©ì„ ì¦ê¹ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1535131749006-b7f58c99034b?q=80&w=1170&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 5, title: 'ğŸš¤ í•´ì–‘ ìŠ¤í¬ì¸ ', description: 'ì œíŠ¸ìŠ¤í‚¤, ë„ë„›, ë°”ë‚˜ë‚˜ë³´íŠ¸,<br>ìŠ¤ë…¸í´ë§ì„ ì¦ê¸°ëŠ”<br>ì•¡í‹°ë¹„í‹° íŒ¨í‚¤ì§€ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1664922114319-4700c0ef74b1?q=80&w=1074&auto=format=fit&crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 6, title: 'ğŸ¢ ì›Œí„°ë´„ ë°œë¦¬', description: 'ë°œë¦¬ ê¾¸ë”°ì— ìœ„ì¹˜í•œ ì¸ê¸° ì›Œí„°íŒŒí¬ì…ë‹ˆë‹¤.<br>ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ì›Œí„°ìŠ¬ë¼ì´ë“œì™€<br>ë‹¤ì–‘í•œ í¸ì˜ì‹œì„¤ì„ ê°–ì¶° ì¦ê¸°ê¸° ì¢‹ì€ ê³³ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1741316041430-4e5362625ff2?q=80&w=1170&auto=format&fit&crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' }
                ];
                
                const addBatch = writeBatch(db);
                defaultPrograms.forEach(program => {
                    const newProgramRef = doc(programsCollectionRef);
                    addBatch.set(newProgramRef, { ...program, votes: 0, voters: [] });
                });
                await addBatch.commit();
                
                showAlert('ì´ˆê¸° ë°ì´í„° ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error("DB ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                showAlert(`DB ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.<br>ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function addDefaultPrograms() {
            if (!isAdminMode || !db) return showAlert('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•´ì•¼ í•˜ê±°ë‚˜, ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');

            const confirmed = await showConfirm("ê¸°ë³¸ í”„ë¡œê·¸ë¨ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? <br>ì´ë¯¸ ëª©ë¡ì— ìˆëŠ” í”„ë¡œê·¸ë¨ì€ ì¤‘ë³µìœ¼ë¡œ ì¶”ê°€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€");
            if (!confirmed) return;

            try {
                showAlert('ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');
                const programsCollectionRef = collection(db, "programs");

                const existingProgramsSnapshot = await getDocs(query(programsCollectionRef));
                const existingOrders = new Set(existingProgramsSnapshot.docs.map(doc => doc.data().order));

                const defaultPrograms = [
                    { order: 1, title: 'ğŸš£ ìš°ë¶“ + ë˜í”„íŒ…', description: 'ì•„ìœµê°•ì—ì„œ ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ë˜í”„íŒ…ì„ ì¦ê¸°ê³ <br>ìš°ë¶“ ì™•ê¶ê³¼ ì „í†µì‹œì¥, ë§ˆì„ì„<br>ë‘˜ëŸ¬ë³´ëŠ” ì½”ìŠ¤ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1624646580989-9f059e25eb78?q=80&w=1170&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 2, title: 'ğŸŒ¿ ìš°ë¶“ + ìŠ¤íŒŒ', description: 'ìš°ë¶“ì˜ ì™•ê¶ê³¼ ì „í†µì‹œì¥, ë§ˆì„ì„ ë‘˜ëŸ¬ë³´ê³ <br>ë°œë¦¬ ì „í†µ ë§ˆì‚¬ì§€ë¥¼ ë°›ìœ¼ë©°<br>ì‹¬ì‹ ì˜ í”¼ë¡œë¥¼ í‘¸ëŠ” íë§ ì½”ìŠ¤ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1708436137498-1b660e94c782?q=80&w=687&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 3, title: 'ğŸ–ï¸ ë¦¬ì¡°íŠ¸ ììœ ì‹œê°„', description: 'ê³ ê¸‰ ë¦¬ì¡°íŠ¸ì˜ ìˆ˜ì˜ì¥ê³¼ ë¶€ëŒ€ì‹œì„¤ì„<br>ë§ˆìŒê» ì´ìš©í•˜ë©° ëˆ„êµ¬ì˜ ë°©í•´ë„ ë°›ì§€ ì•ŠëŠ”<br>ì™„ë²½í•œ ììœ ì‹œê°„ì„ ë§Œë½í•©ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1596178065887-1198b6148b2b?ixlib-rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80' },
                    { order: 4, title: 'ğŸŒï¸â€â™‚ï¸ ê³¨í”„', description: 'ë°œë¦¬ ë‰´ ê¾¸íƒ€ ê³¨í”„ í´ëŸ½ì—ì„œ<br>í™˜ìƒì ì¸ í•´ì•ˆì ˆê²½ì„ ê°ìƒí•˜ë©°<br>ë¼ìš´ë”©ì„ ì¦ê¹ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1535131749006-b7f58c99034b?q=80&w=1170&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 5, title: 'ğŸš¤ í•´ì–‘ ìŠ¤í¬ì¸ ', description: 'ì œíŠ¸ìŠ¤í‚¤, ë„ë„›, ë°”ë‚˜ë‚˜ë³´íŠ¸,<br>ìŠ¤ë…¸í´ë§ì„ ì¦ê¸°ëŠ”<br>ì•¡í‹°ë¹„í‹° íŒ¨í‚¤ì§€ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1664922114319-4700c0ef74b1?q=80&w=1074&auto=format=fit&crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 6, title: 'ğŸ¢ ì›Œí„°ë´„ ë°œë¦¬', description: 'ë°œë¦¬ ê¾¸ë”°ì— ìœ„ì¹˜í•œ ì¸ê¸° ì›Œí„°íŒŒí¬ì…ë‹ˆë‹¤.<br>ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ì›Œí„°ìŠ¬ë¼ì´ë“œì™€<br>ë‹¤ì–‘í•œ í¸ì˜ì‹œì„¤ì„ ê°–ì¶° ì¦ê¸°ê¸° ì¢‹ì€ ê³³ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1741316041430-4e5362625ff2?q=80&w=1170&auto=format=fit&crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' }
                ];

                const programsToAdd = defaultPrograms.filter(p => !existingOrders.has(p.order));

                if (programsToAdd.length === 0) {
                    showAlert('ëª¨ë“  ê¸°ë³¸ í”„ë¡œê·¸ë¨ì´ ì´ë¯¸ ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.', 'ì•Œë¦¼');
                    return;
                }

                const addBatch = writeBatch(db);
                programsToAdd.forEach(program => {
                    const newProgramRef = doc(programsCollectionRef);
                    addBatch.set(newProgramRef, { ...program, votes: 0, voters: [] });
                });
                await addBatch.commit();

                showAlert(`${programsToAdd.length}ê°œì˜ ê¸°ë³¸ í”„ë¡œê·¸ë¨ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'ì¶”ê°€ ì™„ë£Œ');
            } catch (error) {
                console.error("ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                showAlert(`ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ì˜¤ë¥˜: ${error.message}`);
            }
        }

        function exportToExcel() {
            if (!isAdminMode) return showAlert('ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
            if (programs.length === 0) return showAlert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            
            showAlert('ëª¨ë“  íˆ¬í‘œì ì •ë³´ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤...'); 
            const allVoters = []; 
            programs.forEach(p => { 
                if (p.voters?.length) { 
                    p.voters.forEach(v => allVoters.push({ program: p.title.replace(/,/g, ''), id: v.id, name: v.name })); 
                } 
            }); 
            
            if (!allVoters.length) return showAlert('ë‹¤ìš´ë¡œë“œí•  íˆ¬í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); 
            
            const csv = `${"\uFEFF"}"í”„ë¡œê·¸ë¨","ì‚¬ë²ˆ","ì´ë¦„"\n${allVoters.map(v => `"${v.program}","${v.id}","${v.name}"`).join('\n')}`; 
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a"); 
            link.href = URL.createObjectURL(blob); 
            link.download = "bali_vote_results.csv"; 
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>
