<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œë¦¬ ì—¬í–‰ í”„ë¡œê·¸ë¨ ì„ í˜¸ë„ ì¡°ì‚¬</title>

    <meta property="og:title" content="âœ¨ ë°œë¦¬ì—ì„œ ìƒê¸¸ ì¼ âœ¨">
    <meta property="og:description" content="ë°œë¦¬ ì—¬í–‰ ìµœê³ ì˜ í”„ë¡œê·¸ë¨ì„ ë½‘ì•„ì£¼ì„¸ìš”!">
    <meta property="og:image" content="https://github.com/incarmarketing/bali-vote-project/blob/main/thumbnail.jpg?raw=true">
    <meta property="og:url" content="https://incarmarketing.github.io/bali-vote-project/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1537953773345-d172ccf13cf1?q=80&w=1935&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
            background-size: cover; background-position: center; background-attachment: fixed;
            min-height: 100vh; padding: 20px;
        }
        
        .logo-container { text-align: center; margin-bottom: 20px; }
        .company-logo { max-height: 60px; }
        
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, rgba(255,107,107,0.8), rgba(255,167,38,0.8)), url('https://images.unsplash.com/photo-1636619306699-2d27a100605e?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); background-size: cover; background-position: center; color: white; padding: 40px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .main-content { padding: 40px; padding-bottom: 100px; }
        .admin-panel { background: #f8f9fa; border-radius: 15px; padding: 30px; margin-bottom: 40px; border: 2px dashed #dee2e6; display: none; }
        .admin-panel.show { display: block; }
        .admin-toggle { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 15px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; transition: all 0.3s; }
        .admin-toggle:hover { transform: scale(1.1); }
        .admin-panel h2 { color: #495057; margin-bottom: 20px; font-size: 1.5em; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-right: 10px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
        .programs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-top: 30px; }
        .program-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; position: relative; }
        .program-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .program-image { width: 100%; height: 200px; object-fit: cover; }
        .program-content { padding: 25px; }
        .program-title { font-size: 1.3em; font-weight: 700; margin-bottom: 10px; color: #2c3e50; }
        .program-description { color: #7f8c8d; line-height: 1.6; margin-bottom: 20px; }
        .vote-section { display: flex; align-items: center; justify-content: space-between; padding-top: 20px; border-top: 1px solid #ecf0f1; }
        .vote-btn { background: linear-gradient(135deg, #00b894, #00cec9); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .vote-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3); }
        .vote-count { font-weight: 700; color: #2c3e50; font-size: 1.1em; }
        .results-section { background: #f8f9fa; border-radius: 15px; padding: 30px; margin-top: 40px; }
        .results-header { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; position: relative; }
        .results-header h2 { color: #2c3e50; margin: 0; }
        .excel-download-btn { position: absolute; right: 0; background: linear-gradient(135deg, #28a745, #218838); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 14px; cursor: pointer; display: none; }
        .excel-download-btn.show { display: inline-block; }
        .no-programs { text-align: center; color: #7f8c8d; font-size: 1.1em; padding: 40px; }
        .admin-controls { display: none; gap: 10px; margin-top: 15px; }
        .admin-controls.show { display: flex; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%; text-align: center; }
        .modal-content h3 { margin-bottom: 20px; color: #2c3e50; }
        .modal-content input { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; margin-bottom: 20px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        .view-voters-btn { background: #6c757d; color: white; border: none; padding: 5px 10px; font-size: 12px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #voterList { list-style: none; text-align: left; max-height: 300px; overflow-y: auto; }
        #voterList li { padding: 8px; border-bottom: 1px solid #eee; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { padding: 30px 20px; }
            .header h1 { font-size: 2em; }
            .main-content { padding: 20px; padding-bottom: 100px; }
            .programs-grid { grid-template-columns: 1fr; }
            .results-header { flex-direction: column; gap: 15px; }
            .excel-download-btn { position: static; }
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="https://github.com/incarmarketing/bali-vote-project/blob/main/logo.png?raw=true" alt="íšŒì‚¬ ë¡œê³ " class="company-logo" onerror="this.style.display='none'">
    </div>

    <div class="container">
        <div class="header">
            <h1>âœ¨ ë°œë¦¬ì—ì„œ ìƒê¸¸ ì¼ âœ¨</h1>
            <p>í•¨ê»˜ ë– ë‚  ë°œë¦¬ ì—¬í–‰<br>ìµœê³ ì˜ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”!</p>
        </div>
        <div class="main-content">
            <div class="admin-panel" id="adminPanel">
                <h2>âœ¨ í”„ë¡œê·¸ë¨ ì¶”ê°€/í¸ì§‘</h2>
                <form id="programForm">
                    <div class="form-group">
                        <label for="programTitle">í”„ë¡œê·¸ë¨ ì´ë¦„</label>
                        <input type="text" id="programTitle" placeholder="ì˜ˆ: ìš°ë¶“ ë¼ì´ìŠ¤ í…Œë¼ìŠ¤ íˆ¬ì–´">
                    </div>
                    <div class="form-group">
                        <label for="programDescription">í”„ë¡œê·¸ë¨ ì„¤ëª…</label>
                        <textarea id="programDescription" placeholder="í”„ë¡œê·¸ë¨ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="programImage">ì´ë¯¸ì§€ URL (ì„ íƒì‚¬í•­)</label>
                        <input type="url" id="programImage" placeholder="https://example.com/image.jpg">
                    </div>
                    <button type="submit" class="btn">í”„ë¡œê·¸ë¨ ì¶”ê°€</button>
                    <button type="button" class="btn" onclick="clearForm()">ì…ë ¥ ì´ˆê¸°í™”</button>
                </form>
                <hr style="margin: 30px 0; border: 1px solid #eee;">
                <h2 style="color: #c0392b;">ğŸš¨ ìœ„í—˜ êµ¬ì—­ ğŸš¨</h2>
                <button type="button" class="btn btn-danger" onclick="runInitialization()">DB ì´ˆê¸°í™” ë° ê¸°ë³¸ê°’ ì„¤ì •</button>
                <p style="font-size: 14px; color: #7f8c8d; margin-top: 10px;">
                    ì£¼ì˜: ì´ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ DBì˜ ëª¨ë“  í”„ë¡œê·¸ë¨ì´ ì‚­ì œë˜ê³ , ì½”ë“œì— ì •ì˜ëœ ê¸°ë³¸ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ë®ì–´ì”ë‹ˆë‹¤.
                </p>
                </div>
            <div class="programs-grid" id="programsGrid"></div>
            <div class="no-programs" id="noPrograms">í”„ë¡œê·¸ë¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            <div class="results-section">
                 <div class="results-header">
                    <h2>ğŸ“Š ì‹¤ì‹œê°„ íˆ¬í‘œ ê²°ê³¼</h2>
                    <button id="excelDownloadBtn" class="excel-download-btn" onclick="exportToExcel()">ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ</button>
                </div>
                <div id="resultsChart"></div>
            </div>
        </div>
        <button class="admin-toggle" onclick="showPasswordModal()" title="ê´€ë¦¬ì ëª¨ë“œ">ğŸ”§</button>
    </div>

    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h3>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
            <input type="email" id="adminEmail" placeholder="ê´€ë¦¬ì ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
            <input type="password" id="adminPassword" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <div class="modal-buttons">
                <button class="btn" onclick="checkAdminPassword()">ë¡œê·¸ì¸</button>
                <button class="btn btn-danger" onclick="hideModal('passwordModal')">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    <div class="modal" id="voterAuthModal">
        <div class="modal-content">
            <h3>ğŸ—³ï¸ íˆ¬í‘œì ì •ë³´ ì…ë ¥</h3>
            <input type="text" id="voterEmployeeId" placeholder="ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”">
            <input type="text" id="voterName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <div class="modal-buttons">
                <button class="btn" onclick="submitVote()">íˆ¬í‘œí•˜ê¸°</button>
                <button class="btn btn-danger" onclick="hideModal('voterAuthModal')">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    <div class="modal" id="voterListModal">
        <div class="modal-content">
            <h3 id="voterListTitle">íˆ¬í‘œì ëª…ë‹¨</h3>
            <ul id="voterList"></ul>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="hideModal('voterListModal')">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, increment, arrayUnion, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDEcWo6Zf0R_0GtE51DryWNphkK1OjNzx0",
            authDomain: "incarhigh-balihi.firebaseapp.com",
            projectId: "incarhigh-balihi",
            storageBucket: "incarhigh-balihi.firebasestorage.app",
            messagingSenderId: "777053953777",
            appId: "1:777053953777:web:bd21c80707306f54da9350",
            measurementId: "G-T8BW822SLS"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.firebase = {
            collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, increment, arrayUnion, query, orderBy, signInWithEmailAndPassword
        };
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        let programs = [];
        let editingId = null;
        let votingForId = null;
        let isAdminMode = false;

        const { collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, increment, arrayUnion, query, orderBy, signInWithEmailAndPassword } = window.firebase;

        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ ê´€ë¦¬ììš© DB ì´ˆê¸°í™” í•¨ìˆ˜ â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        window.runInitialization = async function() {
            if (!isAdminMode) {
                alert('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•´ì•¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            const confirmation = confirm("ğŸš¨ì •ë§ë¡œ ëª¨ë“  íˆ¬í‘œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ê¸°ë³¸ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
            if (!confirmation) {
                alert('ì´ˆê¸°í™”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                alert('DB ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ê¸°ì¡´ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤...');
                const programsCollection = collection(window.db, "programs");
                const oldDocsSnapshot = await getDocs(programsCollection);
                for (const oldDoc of oldDocsSnapshot.docs) {
                    await deleteDoc(doc(window.db, "programs", oldDoc.id));
                }
                
                alert('ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ. ì´ì œ ê¸°ë³¸ í”„ë¡œê·¸ë¨ì„ ì¶”ê°€í•©ë‹ˆë‹¤.');

                const defaultPrograms = [
                    { order: 1, title: 'ğŸš£ ìš°ë¶“ + ë˜í”„íŒ…', description: 'ì•„ìœµê°•ì—ì„œ ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ë˜í”„íŒ…ì„ ì¦ê¸°ê³ <br>ìš°ë¶“ ì™•ê¶ê³¼ ì „í†µì‹œì¥, ë§ˆì„ì„<br>ë‘˜ëŸ¬ë³´ëŠ” ì½”ìŠ¤ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1624646580989-9f059e25eb78?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 2, title: 'ğŸŒ¿ ìš°ë¶“ + ìŠ¤íŒŒ', description: 'ìš°ë¶“ì˜ ì™•ê¶ê³¼ ì „í†µì‹œì¥, ë§ˆì„ì„ ë‘˜ëŸ¬ë³´ê³ <br>ë°œë¦¬ ì „í†µ ë§ˆì‚¬ì§€ë¥¼ ë°›ìœ¼ë©°<br>ì‹¬ì‹ ì˜ í”¼ë¡œë¥¼ í‘¸ëŠ” íë§ ì½”ìŠ¤ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1708436137498-1b660e94c782?q=80&w=687&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 3, title: 'ğŸ¹ ë¦¬ì¡°íŠ¸ ììœ ì‹œê°„', description: 'ê³ ê¸‰ ë¦¬ì¡°íŠ¸ì˜ ìˆ˜ì˜ì¥ê³¼ ë¶€ëŒ€ì‹œì„¤ì„<br>ë§ˆìŒê» ì´ìš©í•˜ë©° ëˆ„êµ¬ì˜ ë°©í•´ë„ ë°›ì§€ ì•ŠëŠ”<br>ì™„ë²½í•œ ììœ ì‹œê°„ì„ ë§Œë½í•©ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1596178065887-1198b6148b2b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80' },
                    { order: 4, title: 'ğŸŒï¸â€â™‚ï¸ ê³¨í”„', description: 'ë°œë¦¬ ë‰´ ê¾¸íƒ€ ê³¨í”„ í´ëŸ½ì—ì„œ<br>í™˜ìƒì ì¸ í•´ì•ˆì ˆê²½ì„ ê°ìƒí•˜ë©°<br>ë¼ìš´ë”©ì„ ì¦ê¹ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1535131749006-b7f58c99034b?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 5, title: 'ğŸš¤ í•´ì–‘ ìŠ¤í¬ì¸ ', description: 'ì œíŠ¸ìŠ¤í‚¤, ë„ë„›, ë°”ë‚˜ë‚˜ë³´íŠ¸,<br>ìŠ¤ë…¸í´ë§ì„ ì¦ê¸°ëŠ”<br>ì•¡í‹°ë¹„í‹° íŒ¨í‚¤ì§€ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1664922114319-4700c0ef74b1?q=80&w=1074&auto=format=fit&crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 6, title: 'ğŸ¢ ì›Œí„°ë´„ ë°œë¦¬', description: 'ë°œë¦¬ ê¾¸ë”°ì— ìœ„ì¹˜í•œ ì¸ê¸° ì›Œí„°íŒŒí¬ì…ë‹ˆë‹¤.<br>ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ì›Œí„°ìŠ¬ë¼ì´ë“œì™€<br>ë‹¤ì–‘í•œ í¸ì˜ì‹œì„¤ì„ ê°–ì¶° ì¦ê¸°ê¸° ì¢‹ì€ ê³³ì…ë‹ˆë‹¤.', image: 'https://images.unsplash.com/photo-1741316041430-4e5362625ff2?q=80&w=1170&auto=format=fit&crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' }
                ];

                for (const program of defaultPrograms) {
                    await addDoc(programsCollection, {
                        ...program,
                        votes: 0,
                        voters: []
                    });
                }
                alert('ì´ˆê¸° ë°ì´í„° ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤.');
                window.location.reload();
            } catch (error) {
                console.error("DB ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                alert(`DB ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.\nì˜¤ë¥˜: ${error.message}`);
            }
        }
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        async function loadProgramsAndRender() {
            try {
                const programsCollection = collection(window.db, "programs");
                const q = query(programsCollection, orderBy("order"));
                const querySnapshot = await getDocs(q);
                programs = [];
                if (querySnapshot.empty) {
                    const noProgramsEl = document.getElementById('noPrograms');
                    noProgramsEl.textContent = 'í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•˜ì—¬ DBë¥¼ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”.';
                } else {
                    querySnapshot.forEach((doc) => {
                        programs.push({ id: doc.id, ...doc.data() });
                    });
                }
                renderPrograms();
                updateResults();
            } catch (error) {
                console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
                alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ì„¤ì • ë˜ëŠ” ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        }

        window.showModal = (id) => document.getElementById(id).classList.add('show');
        window.hideModal = (id) => document.getElementById(id).classList.remove('show');
        window.showPasswordModal = () => { showModal('passwordModal'); document.getElementById('adminEmail').focus(); }

        window.checkAdminPassword = async () => {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            if (!email || !password) return alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            try {
                await signInWithEmailAndPassword(window.auth, email, password);
                isAdminMode = true;
                document.getElementById('adminPanel').classList.add('show');
                document.getElementById('excelDownloadBtn').classList.add('show');
                hideModal('passwordModal');
                alert('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ! ğŸ”“');
                renderPrograms(); updateResults();
            } catch (error) {
                console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error.code);
                alert('ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminPassword').value = '';
        }

        window.clearForm = () => { document.getElementById('programForm').reset(); editingId = null; document.querySelector('.btn[type="submit"]').textContent = 'í”„ë¡œê·¸ë¨ ì¶”ê°€'; }
        window.requestVote = (id) => { votingForId = id; showModal('voterAuthModal'); document.getElementById('voterEmployeeId').focus(); }

        window.submitVote = async () => {
            const employeeId = document.getElementById('voterEmployeeId').value.trim();
            const name = document.getElementById('voterName').value.trim();
            if (!employeeId || !name) return alert('ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            const allDocs = await getDocs(collection(window.db, "programs"));
            const alreadyVoted = allDocs.docs.some(doc => doc.data().voters?.some(v => v.id === employeeId));
            if (alreadyVoted) return alert('ì´ë¯¸ ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì— íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤. í•œ ì‚¬ëŒë‹¹ í•œ ë²ˆë§Œ íˆ¬í‘œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');

            const programRef = doc(window.db, "programs", votingForId);
            await updateDoc(programRef, { votes: increment(1), voters: arrayUnion({ id: employeeId, name: name }) });
            await loadProgramsAndRender();
            hideModal('voterAuthModal');
            document.getElementById('voterEmployeeId').value = '';
            document.getElementById('voterName').value = '';
        }
        
        function renderPrograms() {
            const grid = document.getElementById('programsGrid');
            const noProgramsEl = document.getElementById('noPrograms');
            if (!programs || programs.length === 0) {
                grid.style.display = 'none';
                noProgramsEl.style.display = 'block';
                return;
            }
            grid.style.display = 'grid';
            noProgramsEl.style.display = 'none';
            grid.innerHTML = programs.map(p => `
                <div class="program-card">
                    <img src="${p.image || 'https://via.placeholder.com/400x200.png?text=No+Image'}" alt="${p.title}" class="program-image" onerror="this.onerror=null; this.src='https://via.placeholder.com/400x200.png?text=Image+Load+Failed';">
                    <div class="program-content">
                        <h3 class="program-title">${p.title}</h3>
                        <p class="program-description">${p.description}</p>
                        <div class="vote-section">
                            <button class="vote-btn" onclick="requestVote('${p.id}')">ğŸ‘ ì´ í”„ë¡œê·¸ë¨ ì„ íƒ</button>
                            <span class="vote-count">${p.votes || 0}í‘œ</span>
                        </div>
                        <div class="admin-controls ${isAdminMode ? 'show' : ''}">
                            <button class="btn" onclick="editProgram('${p.id}')">ìˆ˜ì •</button>
                            <button class="btn btn-danger" onclick="deleteProgram('${p.id}')">ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateResults() {
            const resultsChart = document.getElementById('resultsChart');
            if (!programs || programs.length === 0) {
                resultsChart.innerHTML = '<div class="no-programs">íˆ¬í‘œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>';
                return;
            }
            const totalVotes = programs.reduce((sum, p) => sum + (p.votes || 0), 0);
            const sortedPrograms = [...programs].sort((a, b) => (a.order || 0) - (b.order || 0));
            resultsChart.innerHTML = `
                <div style="margin-bottom: 20px; text-align: center;"><strong>ì´ íˆ¬í‘œ ìˆ˜: ${totalVotes}í‘œ</strong></div>
                ${sortedPrograms.map((p, index) => {
                    const percentage = totalVotes > 0 ? ((p.votes || 0) / totalVotes * 100).toFixed(1) : 0;
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div>
                                    <span style="font-weight: 600;">${p.title}</span>
                                    ${isAdminMode ? `<button class="view-voters-btn" onclick="showVoters('${p.id}')">íˆ¬í‘œì ë³´ê¸°</button>` : ''}
                                </div>
                                <span style="color: #7f8c8d;">${p.votes || 0}í‘œ (${percentage}%)</span>
                            </div>
                            <div style="background: #ecf0f1; border-radius: 10px; height: 20px;"><div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${percentage}%;"></div></div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        window.deleteProgram = async (id) => { if (confirm('ì •ë§ë¡œ ì´ í”„ë¡œê·¸ë¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await deleteDoc(doc(window.db, "programs", id)); await loadProgramsAndRender(); } }
        window.editProgram = async (id) => { const docSnap = await getDoc(doc(window.db, "programs", id)); if (docSnap.exists()) { const p = docSnap.data(); document.getElementById('programTitle').value = p.title; document.getElementById('programDescription').value = p.description; document.getElementById('programImage').value = p.image || ''; editingId = id; document.querySelector('.btn[type="submit"]').textContent = 'í”„ë¡œê·¸ë¨ ìˆ˜ì •'; document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' }); } }
        window.showVoters = (id) => { 
            const p = programs.find(p => p.id === id); 
            if (!p) return; 
            const voterListEl = document.getElementById('voterList'); 
            document.getElementById('voterListTitle').textContent = `[${p.title}] íˆ¬í‘œì ëª…ë‹¨`; 
            const voters = p.voters || []; 
            voterListEl.innerHTML = voters.length ? voters.map(v => `<li>${v.name} (${v.id})</li>`).join('') : '<li>ì•„ì§ íˆ¬í‘œí•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</li>'; 
            showModal('voterListModal'); 
        }
        window.exportToExcel = async () => { 
            alert('ëª¨ë“  íˆ¬í‘œì ì •ë³´ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤...'); 
            const allVoters = []; 
            const querySnapshot = await getDocs(collection(window.db, "programs")); 
            querySnapshot.forEach(d => { 
                const p = { id: d.id, ...d.data() }; 
                if (p.voters?.length) { 
                    p.voters.forEach(v => allVoters.push({ program: p.title.replace(/,/g, ''), id: v.id, name: v.name })); 
                } 
            }); 
            if (!allVoters.length) return alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); 
            const csv = `${"\uFEFF"}"í”„ë¡œê·¸ë¨","ì‚¬ë²ˆ","ì´ë¦„"\n${allVoters.map(v => `"${v.program}","${v.id}","${v.name}"`).join('\n')}`; 
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a"); 
            link.href = URL.createObjectURL(blob); 
            link.download = "bali_vote_results.csv"; 
            link.click(); 
        }
        
        document.getElementById('programForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const title = document.getElementById('programTitle').value.trim();
                const description = document.getElementById('programDescription').value.trim();
                const image = document.getElementById('programImage').value.trim();
                if (!title || !description) return alert('í”„ë¡œê·¸ë¨ ì´ë¦„ê³¼ ì„¤ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                
                const data = { title, description, image };

                if (editingId) {
                    await updateDoc(doc(window.db, "programs", editingId), data);
                    alert('í”„ë¡œê·¸ë¨ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    const maxOrder = programs.reduce((max, p) => Math.max(max, p.order || 0), 0);
                    await addDoc(collection(window.db, "programs"), { ...data, votes: 0, voters: [], order: maxOrder + 1 });
                    alert('ìƒˆë¡œìš´ í”„ë¡œê·¸ë¨ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                clearForm();
                await loadProgramsAndRender();
            } catch (error) {
                console.error("í”„ë¡œê·¸ë¨ ì¶”ê°€/ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                alert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n(ì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message})`);
            }
        });
        
        // í˜ì´ì§€ ë¡œë”© ì‹œ í”„ë¡œê·¸ë¨ ëª©ë¡ì„ ë°”ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
        loadProgramsAndRender();
    });
    </script>
</body>
</html>
