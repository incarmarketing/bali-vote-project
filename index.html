<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>발리 여행 프로그램 선호도 조사</title>

    <!-- 소셜 공유를 위한 Open Graph 메타 태그 -->
    <meta property="og:title" content="✨ 발리에서 생길 일 ✨">
    <meta property="og:description" content="★ 발리 여행 최고의 프로그램을 뽑아주세요 ★">
    <meta property="og:image" content="https://github.com/incarmarketing/bali-vote-project/blob/main/thumbnail.jpg?raw=true">
    <meta property="og:url" content="https://incarmarketing.github.io/bali-vote-project/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <style>
        /* 일반 스타일 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1537953773345-d172ccf13cf1?q=80&w=1935&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
            background-size: cover; background-position: center; background-attachment: fixed;
            min-height: 100vh;
        }
        
        /* 인트로 영상 스플래시 화면 */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 1s ease-out;
        }
        #intro-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center; /* 데스크탑에서는 중앙 정렬 */
        }
        #skip-intro {
            position: absolute; bottom: 30px; right: 30px;
            background-color: rgba(0, 0, 0, 0.7); color: white;
            border: 1px solid white; padding: 10px 20px;
            border-radius: 20px; cursor: pointer; font-size: 14px; z-index: 10001;
        }
        
        /* 메인 콘텐츠 래퍼 */
        .main-wrapper {
            padding: 20px; opacity: 0; /* 처음에는 숨김 */
            transition: opacity 1s ease-in;
        }
        .main-wrapper.visible { opacity: 1; }

        .logo-container { text-align: center; margin-bottom: 20px; }
        .company-logo { max-height: 60px; }
        
        /* 음악 토글 버튼 */
        #music-toggle {
            position: fixed; bottom: 20px; left: 20px;
            background-color: rgba(0, 0, 0, 0.5); color: white;
            border: 1px solid white; width: 50px; height: 50px;
            border-radius: 50%; font-size: 24px; cursor: pointer;
            z-index: 1000; display: flex; justify-content: center; align-items: center;
        }

        /* 핵심 레이아웃 */
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, rgba(255,107,107,0.8), rgba(255,167,38,0.8)), url('https://images.unsplash.com/photo-1636619306699-2d27a100605e?q=80&w=1170&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); background-size: cover; background-position: center; color: white; padding: 40px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .main-content { padding: 40px; padding-bottom: 100px; }
        
        /* 관리자 패널 */
        .admin-panel { background: #f8f9fa; border-radius: 15px; padding: 30px; margin-bottom: 40px; border: 2px dashed #dee2e6; display: none; }
        .admin-panel.show { display: block; }
        .admin-toggle { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 15px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; transition: all 0.3s; }
        .admin-toggle:hover { transform: scale(1.1); }
        .admin-toggle:disabled {
            background: linear-gradient(135deg, #9E9E9E, #757575);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .admin-toggle:disabled:hover { transform: none; }
        .admin-toggle.failed { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .admin-panel h2 { color: #495057; margin-bottom: 20px; font-size: 1.5em; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        
        /* 버튼 */
        .btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-right: 10px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d, #495057); }
        
        /* 프로그램 카드 */
        .programs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-top: 30px; }
        .program-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; position: relative; }
        .program-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .program-image { width: 100%; height: 200px; object-fit: cover; }
        .program-content { padding: 25px; }
        .program-title { font-size: 1.3em; font-weight: 700; margin-bottom: 10px; color: #2c3e50; }
        .program-description { color: #7f8c8d; line-height: 1.6; margin-bottom: 20px; min-height: 75px; }
        .vote-section { display: flex; align-items: center; justify-content: space-between; padding-top: 20px; border-top: 1px solid #ecf0f1; }
        .vote-btn { background: linear-gradient(135deg, #00b894, #00cec9); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .vote-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3); }
        .vote-count { font-weight: 700; color: #2c3e50; font-size: 1.1em; }
        .admin-controls { display: none; gap: 10px; margin-top: 15px; }
        .admin-controls.show { display: flex; }

        /* 결과 섹션 */
        .results-section { background: #f8f9fa; border-radius: 15px; padding: 30px; margin-top: 40px; }
        .results-header { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; position: relative; }
        .results-header h2 { color: #2c3e50; margin: 0; }
        .excel-download-btn { position: absolute; right: 0; background: linear-gradient(135deg, #28a745, #218838); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 14px; cursor: pointer; display: none; }
        .excel-download-btn.show { display: inline-block; }
        .no-programs { text-align: center; color: #7f8c8d; font-size: 1.1em; padding: 40px; }
        
        /* 모달 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%; text-align: center; animation: modal-appear 0.3s ease-out; }
        @keyframes modal-appear { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-content h3 { margin-bottom: 20px; color: #2c3e50; }
        .modal-content p { margin-bottom: 20px; color: #495057; line-height: 1.6; }
        .modal-content input { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; margin-bottom: 20px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        
        /* 투표자 목록 모달 */
        .view-voters-btn { background: #6c757d; color: white; border: none; padding: 5px 10px; font-size: 12px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #voterList { list-style: none; text-align: left; max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; }
        #voterList li { padding: 8px; border-bottom: 1px solid #eee; }
        #voterList li:last-child { border-bottom: none; }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .main-wrapper { padding: 10px; }
            .header { padding: 30px 20px; }
            .header h1 { font-size: 2em; }
            .main-content { padding: 20px; padding-bottom: 100px; }
            .programs-grid { grid-template-columns: 1fr; }
            .results-header { flex-direction: column; gap: 15px; }
            .excel-download-btn { position: static; }
            #intro-video {
                object-position: 75% 50%;
            }
        }
    </style>
</head>
<body>
    <!-- 스플래시 화면 -->
    <div id="splash-screen">
        <video id="intro-video" src="https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/intro.mp4" autoplay muted playsinline></video>
        <button id="skip-intro">인트로 건너뛰기 &gt;</button>
    </div>

    <!-- 배경 음악 -->
    <audio id="background-music" src="https://cdn.pixabay.com/download/audio/2022/08/27/audio_2932470728.mp3" loop></audio>
    <button id="music-toggle">🔇</button>

    <!-- 메인 콘텐츠 -->
    <div class="main-wrapper">
        <div class="logo-container">
            <img src="https://github.com/incarmarketing/bali-vote-project/blob/main/logo.png?raw=true" alt="회사 로고" class="company-logo" onerror="this.style.display='none'">
        </div>

        <div class="container">
            <div class="header">
                <h1>✨ 발리에서 생길 일 ✨</h1>
                <p>함께 떠날 발리 여행<br>최고의 프로그램을 선택해주세요!</p>
            </div>
            <div class="main-content">
                <!-- 관리자 패널 -->
                <div class="admin-panel" id="adminPanel">
                    <h2>✨ 프로그램 추가/편집</h2>
                    <form id="programForm">
                        <div class="form-group"><label for="programTitle">프로그램 이름</label><input type="text" id="programTitle" placeholder="예: 우붓 라이스 테라스 투어" required></div>
                        <div class="form-group"><label for="programDescription">프로그램 설명</label><textarea id="programDescription" placeholder="프로그램에 대한 자세한 설명을 입력해주세요..." required></textarea></div>
                        <div class="form-group"><label for="programImage">이미지 URL (선택사항)</label><input type="url" id="programImage" placeholder="https://example.com/image.jpg"></div>
                        <button type="submit" class="btn">프로그램 추가</button>
                        <button type="button" class="btn btn-danger" id="clearFormBtn">입력 초기화</button>
                    </form>
                    <hr style="margin: 30px 0; border: 1px solid #eee;">
                    <h2 style="color: #495057;">✨ 데이터 관리</h2>
                    <button type="button" class="btn" id="addDefaultsBtn">기본 프로그램 추가</button>
                    <p style="font-size: 14px; color: #7f8c8d; margin-top: 10px; margin-bottom: 20px;">
                        현재 목록에 없는 기본 프로그램을 추가합니다. 기존 데이터는 삭제되지 않습니다.
                    </p>
                    <h2 style="color: #c0392b;">🚨 위험 구역 🚨</h2>
                    <button type="button" class="btn btn-danger" id="initDbBtn">DB 초기화 및 기본값 설정</button>
                    <p style="font-size: 14px; color: #7f8c8d; margin-top: 10px;">
                        주의: 이 버튼을 누르면 DB의 모든 프로그램이 삭제되고, 코드에 정의된 기본 프로그램으로 덮어씁니다.
                    </p>
                </div>
                
                <!-- 프로그램 카드 -->
                <div class="programs-grid" id="programsGrid"></div>
                <div class="no-programs" id="noPrograms">프로그램을 불러오는 중입니다...</div>
                
                <!-- 결과 섹션 -->
                <div class="results-section">
                    <div class="results-header">
                        <h2>📊 실시간 투표 결과</h2>
                        <button id="excelDownloadBtn" class="excel-download-btn">엑셀로 다운로드</button>
                    </div>
                    <div id="resultsChart"></div>
                </div>
            </div>
            <button class="admin-toggle" id="adminToggleBtn" title="초기화 중..." disabled>🔧</button>
        </div>
    </div>

    <!-- 모달 -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h3>🔐 관리자 로그인</h3>
            <p style="font-size:14px; color:#7f8c8d;">Firebase 콘솔에서 생성한<br>관리자 계정으로 로그인하세요.</p>
            <input type="email" id="adminEmail" placeholder="관리자 이메일을 입력하세요">
            <input type="password" id="adminPassword" placeholder="관리자 비밀번호를 입력하세요">
            <div class="modal-buttons">
                <button class="btn" id="loginBtn">로그인</button>
                <button class="btn btn-danger" onclick="hideModal('passwordModal')">취소</button>
            </div>
        </div>
    </div>
    <div class="modal" id="voterAuthModal">
        <div class="modal-content">
            <h3>🗳️ 투표자 정보 입력</h3>
            <input type="text" id="voterEmployeeId" placeholder="사번을 입력하세요">
            <input type="text" id="voterName" placeholder="이름을 입력하세요">
            <div class="modal-buttons">
                <button class="btn" id="submitVoteBtn">투표하기</button>
                <button class="btn btn-danger" onclick="hideModal('voterAuthModal')">취소</button>
            </div>
        </div>
    </div>
    <div class="modal" id="voterListModal">
        <div class="modal-content">
            <h3 id="voterListTitle">투표자 명단</h3>
            <ul id="voterList"></ul>
            <div class="modal-buttons" style="margin-top: 20px;"><button class="btn btn-danger" onclick="hideModal('voterListModal')">닫기</button></div>
        </div>
    </div>
    <!-- 일반 알림/확인 모달 -->
    <div class="modal" id="alertModal">
        <div class="modal-content">
            <h3 id="alertTitle">알림</h3>
            <p id="alertMessage"></p>
            <div class="modal-buttons">
                <button class="btn" id="alertOkBtn">확인</button>
                <button class="btn btn-secondary" id="alertCancelBtn" style="display:none;">취소</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase 모듈 가져오기 (최신 버전으로 통일)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, increment, arrayUnion, onSnapshot, writeBatch, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 전역 변수 및 설정 ---
        let db, auth;
        let programs = [];
        let editingId = null;
        let votingForId = null;
        let isAdminMode = false;
        let unsubscribePrograms = null; // 리스너 구독 해제 함수를 저장하기 위함

        // --- DOM 요소 ---
        const splashScreen = document.getElementById('splash-screen');
        const introVideo = document.getElementById('intro-video');
        const mainWrapper = document.querySelector('.main-wrapper');
        const music = document.getElementById('background-music');
        const programsGrid = document.getElementById('programsGrid');
        const noProgramsEl = document.getElementById('noPrograms');
        const programForm = document.getElementById('programForm');
        const adminToggleBtn = document.getElementById('adminToggleBtn');

        // --- 모달 도우미 함수 ---
        window.showModal = (id) => document.getElementById(id).classList.add('show');
        window.hideModal = (id) => document.getElementById(id).classList.remove('show');

        // --- 커스텀 알림/확인 창 ---
        const showAlert = (message, title = '알림', onOk) => {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').innerHTML = message;
            const okBtn = document.getElementById('alertOkBtn');
            const cancelBtn = document.getElementById('alertCancelBtn');
            cancelBtn.style.display = 'none';
            
            okBtn.onclick = () => {
                hideModal('alertModal');
                if (onOk) onOk();
            };
            showModal('alertModal');
        };

        const showConfirm = (message, title = '확인 필요') => {
            return new Promise((resolve) => {
                document.getElementById('alertTitle').textContent = title;
                document.getElementById('alertMessage').innerHTML = message;
                const okBtn = document.getElementById('alertOkBtn');
                const cancelBtn = document.getElementById('alertCancelBtn');
                cancelBtn.style.display = 'inline-block';

                okBtn.onclick = () => { hideModal('alertModal'); resolve(true); };
                cancelBtn.onclick = () => { hideModal('alertModal'); resolve(false); };
                showModal('alertModal');
            });
        };

        // --- 초기화 ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
            playIntroVideo();
            playMusic();
        });

        async function initializeFirebase() {
            try {
                // =======================================================================
                // [중요] 깃허브 배포 시 이 부분을 자신의 Firebase 프로젝트 정보로 교체하세요!
                // Firebase 콘솔 > 프로젝트 설정 > 일반 > 내 앱 > SDK 설정 및 구성
                // '구성(config)' 옵션을 선택하여 아래 내용을 복사/붙여넣기 하세요.
                // =======================================================================
                const firebaseConfig = {
                  apiKey: "YOUR_API_KEY",
                  authDomain: "YOUR_AUTH_DOMAIN",
                  projectId: "YOUR_PROJECT_ID",
                  storageBucket: "YOUR_STORAGE_BUCKET",
                  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                  appId: "YOUR_APP_ID"
                };

                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    throw new Error("Firebase 설정이 필요합니다. 스크립트에서 firebaseConfig 변수를 자신의 프로젝트 정보로 교체해주세요.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                adminToggleBtn.disabled = false;
                adminToggleBtn.title = '관리자 모드';
                console.log("Firebase is ready. Admin functions are now available.");

                // [수정됨] 사용자 인증 상태 변화 감지 로직 강화
                onAuthStateChanged(auth, user => {
                    // 사용자가 있고, 익명이 아닌 경우에만 관리자로 간주
                    if (user && !user.isAnonymous) {
                        console.log("관리자로 인증됨:", user.uid);
                        isAdminMode = true;
                        document.getElementById('adminPanel').classList.add('show');
                        document.getElementById('excelDownloadBtn').classList.add('show');
                    } else {
                        // 그 외 모든 경우(익명 사용자, 로그아웃 상태 등)는 관리자가 아님
                        console.log("관리자 아님 (익명 또는 로그아웃):", user ? user.uid : '없음');
                        isAdminMode = false;
                        document.getElementById('adminPanel').classList.remove('show');
                        document.getElementById('excelDownloadBtn').classList.remove('show');
                    }
                    // 모든 경우에 UI를 다시 렌더링하여 관리자 버튼 등을 올바르게 표시
                    renderPrograms();
                    updateResults();
                });
                
                await signInAnonymously(auth);
                
                loadAndListenPrograms();

            } catch (error) {
                console.error("Firebase 초기화 실패:", error);
                showAlert(`Firebase 초기화에 실패했습니다. <br><br><b>오류: ${error.message}</b><br><br>페이지를 새로고침 하시거나, 관리자에게 문의하세요.`, "치명적 오류");
                
                adminToggleBtn.disabled = true;
                adminToggleBtn.title = '초기화 실패! 새로고침하세요.';
                adminToggleBtn.classList.add('failed');
                adminToggleBtn.innerHTML = '❌';
            }
        }

        // --- 이벤트 리스너 설정 ---
        function setupEventListeners() {
            document.getElementById('skip-intro').onclick = showMainContent;
            introVideo.onended = showMainContent;
            
            introVideo.addEventListener('error', (e) => {
                console.error("비디오 로드 오류:", e);
                showMainContent();
            });

            document.getElementById('music-toggle').addEventListener('click', toggleMusic);
            adminToggleBtn.onclick = () => showModal('passwordModal');
            document.getElementById('loginBtn').onclick = checkAdminPassword;
            document.getElementById('clearFormBtn').onclick = clearForm;
            document.getElementById('initDbBtn').onclick = runInitialization;
            document.getElementById('addDefaultsBtn').onclick = addDefaultPrograms;
            document.getElementById('submitVoteBtn').onclick = submitVote;
            document.getElementById('excelDownloadBtn').onclick = exportToExcel;
            programForm.addEventListener('submit', handleFormSubmit);
        }

        // --- 인트로 및 음악 관련 ---
        function playIntroVideo() {
            const playPromise = introVideo.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.warn("영상 자동 재생 실패. 사용자 상호작용이 필요합니다.", error);
                    splashScreen.addEventListener('click', () => introVideo.play(), { once: true });
                });
            }
        }
        
        function playMusic() {
            music.muted = true;
            music.play().catch(() => {
                console.warn('음악 재생을 위해 사용자의 상호작용이 필요합니다.');
                document.body.addEventListener('click', () => {
                    if (music.paused) music.play();
                }, { once: true });
            });
        }

        function showMainContent() {
            if (splashScreen.style.display === 'none') return;
            splashScreen.style.opacity = '0';
            setTimeout(() => {
                splashScreen.style.display = 'none';
                mainWrapper.classList.add('visible');
                const musicToggle = document.getElementById('music-toggle');
                if (musicToggle.textContent === '🔊') {
                    music.muted = false;
                }
            }, 1000);
        }
        
        function toggleMusic() {
            music.muted = !music.muted;
            document.getElementById('music-toggle').textContent = music.muted ? '🔇' : '🔊';
        }

        // --- 핵심 앱 로직 ---
        function loadAndListenPrograms() {
            if (!db) {
                console.error("Firestore DB가 초기화되지 않았습니다.");
                noProgramsEl.textContent = '데이터베이스 연결 오류. 새로고침 해주세요.';
                return;
            }
            const programsCollectionRef = collection(db, "programs");
            
            if (unsubscribePrograms) unsubscribePrograms();

            unsubscribePrograms = onSnapshot(query(programsCollectionRef), (querySnapshot) => {
                programs = [];
                if (querySnapshot.empty) {
                    noProgramsEl.textContent = '프로그램이 없습니다. 관리자로 로그인하여 DB를 초기화해주세요.';
                } else {
                    querySnapshot.forEach((doc) => {
                        programs.push({ id: doc.id, ...doc.data() });
                    });
                    programs.sort((a, b) => (a.order || 0) - (b.order || 0));
                }
                renderPrograms();
                updateResults();
            }, (error) => {
                console.error("데이터 수신 오류:", error);
                showAlert(`실시간 데이터 수신에 실패했습니다. <br><br>오류: ${error.message}`, "데이터 오류");
                noProgramsEl.textContent = '데이터를 불러오는 중 오류가 발생했습니다.';
            });
        }

        function renderPrograms() {
            if (!programsGrid) return;
            if (!programs || programs.length === 0) {
                programsGrid.style.display = 'none';
                noProgramsEl.style.display = 'block';
                return;
            }
            programsGrid.style.display = 'grid';
            noProgramsEl.style.display = 'none';

            programsGrid.innerHTML = programs.map(p => `
                <div class="program-card">
                    <img src="${p.image || 'https://placehold.co/400x200/png?text=이미지+없음'}" alt="${p.title}" class="program-image" onerror="this.onerror=null; this.src='https://placehold.co/400x200/png?text=이미지+오류';">
                    <div class="program-content">
                        <h3 class="program-title">${p.title}</h3>
                        <p class="program-description">${p.description}</p>
                        <div class="vote-section">
                            <button class="vote-btn" onclick="requestVote('${p.id}')">👍 이 프로그램 선택</button>
                            <span class="vote-count">${p.votes || 0}표</span>
                        </div>
                        <div class="admin-controls ${isAdminMode ? 'show' : ''}">
                            <button class="btn" onclick="editProgram('${p.id}')">수정</button>
                            <button class="btn btn-danger" onclick="deleteProgram('${p.id}')">삭제</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateResults() {
            const resultsChart = document.getElementById('resultsChart');
            if (!resultsChart) return;
            if (!programs || programs.length === 0) {
                resultsChart.innerHTML = '<div class="no-programs">투표 결과가 여기에 표시됩니다.</div>';
                return;
            }
            const totalVotes = programs.reduce((sum, p) => sum + (p.votes || 0), 0);
            
            resultsChart.innerHTML = `
                <div style="margin-bottom: 20px; text-align: center;"><strong>총 투표 수: ${totalVotes}표</strong></div>
                ${programs.map(p => {
                    const percentage = totalVotes > 0 ? ((p.votes || 0) / totalVotes * 100).toFixed(1) : 0;
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div>
                                    <span style="font-weight: 600;">${p.title}</span>
                                    ${isAdminMode ? `<button class="view-voters-btn" onclick="showVoters('${p.id}')">투표자 보기</button>` : ''}
                                </div>
                                <span style="color: #7f8c8d;">${p.votes || 0}표 (${percentage}%)</span>
                            </div>
                            <div style="background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${percentage}%; transition: width 0.5s ease-in-out;"></div>
                            </div>
                        </div>`;
                }).join('')}
            `;
        }

        // --- 투표 로직 ---
        window.requestVote = (id) => {
            if (!db) return showAlert('데이터베이스가 준비되지 않았습니다. 잠시 후 다시 시도해주세요.');
            votingForId = id;
            showModal('voterAuthModal');
            document.getElementById('voterEmployeeId').focus();
        };

        async function submitVote() {
            if (!db) return showAlert('데이터베이스가 준비되지 않았습니다. 잠시 후 다시 시도해주세요.');
            const employeeId = document.getElementById('voterEmployeeId').value.trim();
            const name = document.getElementById('voterName').value.trim();
            if (!employeeId || !name) {
                return showAlert('사번과 이름을 모두 입력해주세요.');
            }
            
            const alreadyVoted = programs.some(p => p.voters?.some(v => v.id === employeeId));
            if (alreadyVoted) {
                hideModal('voterAuthModal');
                return showAlert('이미 다른 프로그램에 투표하셨습니다. 한 사람당 한 번만 투표할 수 있습니다.');
            }
            
            try {
                const programRef = doc(db, "programs", votingForId);
                await updateDoc(programRef, { 
                    votes: increment(1), 
                    voters: arrayUnion({ id: employeeId, name: name }) 
                });
                
                hideModal('voterAuthModal');
                document.getElementById('voterEmployeeId').value = '';
                document.getElementById('voterName').value = '';
                showAlert('투표가 성공적으로 완료되었습니다!', '투표 완료');
            } catch (error) {
                console.error("투표 중 오류:", error);
                showAlert(`투표 중 오류가 발생했습니다. <br><br>오류: ${error.message}`, "오류");
            }
        }

        // --- 관리자 로직 ---
        async function checkAdminPassword() {
            if (!auth) return showAlert('Firebase 인증 서비스가 아직 준비되지 않았습니다. 잠시 후 다시 시도해주세요.', '초기화 중');

            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            if (!email || !password) return showAlert('이메일과 비밀번호를 모두 입력해주세요.');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideModal('passwordModal');
                showAlert('관리자 로그인 성공! 🔓');
            } catch (error) {
                console.error("로그인 실패 상세 정보:", error);
                let errorDetails = `<b>오류 코드:</b> ${error.code || '정의되지 않음'}<br><b>오류 메시지:</b> ${error.message || '메시지 없음'}`;
                showAlert(`로그인에 실패했습니다. 아래 상세 정보를 확인하여 원인을 파악해주세요.<br><br>${errorDetails}`, '로그인 오류');
            } finally {
                document.getElementById('adminPassword').value = '';
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!isAdminMode || !db) return showAlert('관리자만 사용 가능하거나, 데이터베이스가 준비되지 않았습니다.');
            
            const title = document.getElementById('programTitle').value.trim();
            const description = document.getElementById('programDescription').value.trim();
            const image = document.getElementById('programImage').value.trim();
            if (!title || !description) return showAlert('프로그램 이름과 설명을 모두 입력해주세요.');
            
            const programsCollectionRef = collection(db, "programs");
            const data = { title, description, image };

            try {
                if (editingId) {
                    await updateDoc(doc(programsCollectionRef, editingId), data);
                    showAlert('프로그램이 성공적으로 수정되었습니다.');
                } else {
                    const maxOrder = programs.reduce((max, p) => Math.max(max, p.order || 0), 0);
                    await addDoc(programsCollectionRef, { ...data, votes: 0, voters: [], order: maxOrder + 1 });
                    showAlert('새로운 프로그램이 성공적으로 추가되었습니다.');
                }
                clearForm();
            } catch (error) {
                console.error("프로그램 추가/수정 오류:", error);
                showAlert(`오류가 발생했습니다. 다시 시도해주세요.<br>(오류 메시지: ${error.message})`);
            }
        }
        
        function clearForm() {
            programForm.reset();
            editingId = null;
            document.querySelector('#programForm button[type="submit"]').textContent = '프로그램 추가';
        }

        window.editProgram = (id) => {
            if (!isAdminMode) return;
            const p = programs.find(prog => prog.id === id);
            if (p) {
                document.getElementById('programTitle').value = p.title;
                document.getElementById('programDescription').value = p.description.replace(/<br\s*\/?>/gi, '\n');
                document.getElementById('programImage').value = p.image || '';
                editingId = id;
                document.querySelector('#programForm button[type="submit"]').textContent = '프로그램 수정';
                document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
            }
        };

        window.deleteProgram = async (id) => {
            if (!isAdminMode || !db) return;
            const confirmed = await showConfirm('정말로 이 프로그램을 삭제하시겠습니까? 투표 정보도 함께 삭제됩니다.', '삭제 확인');
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, "programs", id));
                    showAlert('프로그램이 삭제되었습니다.');
                } catch (error) {
                    console.error("삭제 오류:", error);
                    showAlert(`삭제 중 오류가 발생했습니다: ${error.message}`);
                }
            }
        };
        
        window.showVoters = (id) => { 
            if (!isAdminMode) return;
            const p = programs.find(p => p.id === id); 
            if (!p) return; 
            const voterListEl = document.getElementById('voterList'); 
            document.getElementById('voterListTitle').textContent = `[${p.title}] 투표자 명단`; 
            const voters = p.voters || []; 
            voterListEl.innerHTML = voters.length ? voters.map(v => `<li>${v.name} (${v.id})</li>`).join('') : '<li>아직 투표한 사람이 없습니다.</li>'; 
            showModal('voterListModal'); 
        };

        async function runInitialization() {
            if (!isAdminMode || !db) return showAlert('관리자로 로그인해야 하거나, 데이터베이스가 준비되지 않았습니다.');
            
            const confirmed = await showConfirm("🚨정말로 모든 투표 데이터를 삭제하고 기본 프로그램으로 덮어쓰시겠습니까?<br>이 작업은 되돌릴 수 없습니다!", "DB 초기화 확인");
            if (!confirmed) return showAlert('초기화가 취소되었습니다.');

            try {
                showAlert('DB 초기화를 시작합니다. 잠시만 기다려주세요...');
                const programsCollectionRef = collection(db, "programs");
                
                const oldDocsSnapshot = await getDocs(query(programsCollectionRef));
                const deleteBatch = writeBatch(db);
                oldDocsSnapshot.forEach(doc => deleteBatch.delete(doc.ref));
                await deleteBatch.commit();
                
                const defaultPrograms = [
                    { order: 1, title: '🚣 우붓 + 래프팅', description: '아융강에서 스릴 넘치는 래프팅을 즐기고<br>우붓 왕궁과 전통시장, 마을을<br>둘러보는 코스입니다.', image: 'https://images.unsplash.com/photo-1624646580989-9f059e25eb78?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 2, title: '🌿 우붓 + 스파', description: '우붓의 왕궁과 전통시장, 마을을 둘러보고<br>발리 전통 마사지를 받으며<br>심신의 피로를 푸는 힐링 코스입니다.', image: 'https://images.unsplash.com/photo-1708436137498-1b660e94c782?q=80&w=687&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 3, title: '🏖️ 리조트 자유시간', description: '고급 리조트의 수영장과 부대시설을<br>마음껏 이용하며 누구의 방해도 받지 않는<br>완벽한 자유시간을 만끽합니다.', image: 'https://images.unsplash.com/photo-1596178065887-1198b6148b2b?ixlib-rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80' },
                    { order: 4, title: '🏌️‍♂️ 골프', description: '발리 뉴 꾸타 골프 클럽에서<br>환상적인 해안절경을 감상하며<br>라운딩을 즐깁니다.', image: 'https://images.unsplash.com/photo-1535131749006-b7f58c99034b?q=80&w=1170&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 5, title: '🚤 해양 스포츠', description: '제트스키, 도넛, 바나나보트,<br>스노클링을 즐기는<br>액티비티 패키지입니다.', image: 'https://images.unsplash.com/photo-1664922114319-4700c0ef74b1?q=80&w=1074&auto=format=fit&crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 6, title: '🎢 워터봄 발리', description: '발리 꾸따에 위치한 인기 워터파크입니다.<br>스릴 넘치는 워터슬라이드와<br>다양한 편의시설을 갖춰 즐기기 좋은 곳입니다.', image: 'https://images.unsplash.com/photo-1741316041430-4e5362625ff2?q=80&w=1170&auto=format&fit&crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' }
                ];
                
                const addBatch = writeBatch(db);
                defaultPrograms.forEach(program => {
                    const newProgramRef = doc(programsCollectionRef);
                    addBatch.set(newProgramRef, { ...program, votes: 0, voters: [] });
                });
                await addBatch.commit();
                
                showAlert('초기 데이터 설정이 완료되었습니다.', '초기화 완료');
            } catch (error) {
                console.error("DB 초기화 중 오류 발생:", error);
                showAlert(`DB 초기화에 실패했습니다. Firebase 권한을 확인해주세요.<br>오류: ${error.message}`);
            }
        }

        async function addDefaultPrograms() {
            if (!isAdminMode || !db) return showAlert('관리자로 로그인해야 하거나, 데이터베이스가 준비되지 않았습니다.');

            const confirmed = await showConfirm("기본 프로그램을 추가하시겠습니까? <br>이미 목록에 있는 프로그램은 중복으로 추가되지 않습니다.", "기본 프로그램 추가");
            if (!confirmed) return;

            try {
                showAlert('기본 프로그램 추가를 시작합니다...');
                const programsCollectionRef = collection(db, "programs");

                const existingProgramsSnapshot = await getDocs(query(programsCollectionRef));
                const existingOrders = new Set(existingProgramsSnapshot.docs.map(doc => doc.data().order));

                const defaultPrograms = [
                    { order: 1, title: '🚣 우붓 + 래프팅', description: '아융강에서 스릴 넘치는 래프팅을 즐기고<br>우붓 왕궁과 전통시장, 마을을<br>둘러보는 코스입니다.', image: 'https://images.unsplash.com/photo-1624646580989-9f059e25eb78?q=80&w=1170&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 2, title: '🌿 우붓 + 스파', description: '우붓의 왕궁과 전통시장, 마을을 둘러보고<br>발리 전통 마사지를 받으며<br>심신의 피로를 푸는 힐링 코스입니다.', image: 'https://images.unsplash.com/photo-1708436137498-1b660e94c782?q=80&w=687&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 3, title: '🏖️ 리조트 자유시간', description: '고급 리조트의 수영장과 부대시설을<br>마음껏 이용하며 누구의 방해도 받지 않는<br>완벽한 자유시간을 만끽합니다.', image: 'https://images.unsplash.com/photo-1596178065887-1198b6148b2b?ixlib-rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80' },
                    { order: 4, title: '🏌️‍♂️ 골프', description: '발리 뉴 꾸타 골프 클럽에서<br>환상적인 해안절경을 감상하며<br>라운딩을 즐깁니다.', image: 'https://images.unsplash.com/photo-1535131749006-b7f58c99034b?q=80&w=1170&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 5, title: '🚤 해양 스포츠', description: '제트스키, 도넛, 바나나보트,<br>스노클링을 즐기는<br>액티비티 패키지입니다.', image: 'https://images.unsplash.com/photo-1664922114319-4700c0ef74b1?q=80&w=1074&auto=format=fit&crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { order: 6, title: '🎢 워터봄 발리', description: '발리 꾸따에 위치한 인기 워터파크입니다.<br>스릴 넘치는 워터슬라이드와<br>다양한 편의시설을 갖춰 즐기기 좋은 곳입니다.', image: 'https://images.unsplash.com/photo-1741316041430-4e5362625ff2?q=80&w=1170&auto=format=fit&crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' }
                ];

                const programsToAdd = defaultPrograms.filter(p => !existingOrders.has(p.order));

                if (programsToAdd.length === 0) {
                    showAlert('모든 기본 프로그램이 이미 목록에 있습니다.', '알림');
                    return;
                }

                const addBatch = writeBatch(db);
                programsToAdd.forEach(program => {
                    const newProgramRef = doc(programsCollectionRef);
                    addBatch.set(newProgramRef, { ...program, votes: 0, voters: [] });
                });
                await addBatch.commit();

                showAlert(`${programsToAdd.length}개의 기본 프로그램이 추가되었습니다.`, '추가 완료');
            } catch (error) {
                console.error("기본 프로그램 추가 중 오류 발생:", error);
                showAlert(`기본 프로그램 추가에 실패했습니다.<br>오류: ${error.message}`);
            }
        }

        function exportToExcel() {
            if (!isAdminMode) return showAlert('관리자만 사용할 수 있는 기능입니다.');
            if (programs.length === 0) return showAlert('다운로드할 데이터가 없습니다.');
            
            showAlert('모든 투표자 정보를 준비합니다...'); 
            const allVoters = []; 
            programs.forEach(p => { 
                if (p.voters?.length) { 
                    p.voters.forEach(v => allVoters.push({ program: p.title.replace(/,/g, ''), id: v.id, name: v.name })); 
                } 
            }); 
            
            if (!allVoters.length) return showAlert('다운로드할 투표 데이터가 없습니다.'); 
            
            const csv = `${"\uFEFF"}"프로그램","사번","이름"\n${allVoters.map(v => `"${v.program}","${v.id}","${v.name}"`).join('\n')}`; 
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a"); 
            link.href = URL.createObjectURL(blob); 
            link.download = "bali_vote_results.csv"; 
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>
