<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œë¦¬ ì—¬í–‰ í”„ë¡œê·¸ë¨ ì„ í˜¸ë„ ì¡°ì‚¬</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Noto Sans KR, and Playfair Display for Neon Effect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Social sharing meta tags -->
    <meta property="og:title" content="âœ¨ ë°œë¦¬, ìš°ë¦¬ë¥¼ ìœ„í•œ ì™„ë²½í•œ í•˜ë£¨ âœ¨">
    <meta property="og:description" content="ê°€ì¥ ê¸°ëŒ€ë˜ëŠ” ìˆœê°„ì— íˆ¬í‘œí•´ì£¼ì„¸ìš”.">
    <meta property="og:image" content="https://github.com/incarmarketing/bali-vote-project/blob/main/thumbnail.jpg?raw=true">
    <meta property="og:url" content="https://incarmarketing.github.io/bali-vote-project/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #0a101f; /* Dark blue background */
        }
        
        /* Modal pop-up animation */
        @keyframes modal-appear {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .modal-appear {
            animation: modal-appear 0.3s ease-out forwards;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Neon Sign Effect Base */
        .neon-text {
            font-family: 'Playfair Display', serif;
            text-transform: uppercase;
            font-weight: 700;
            color: #fff;
            line-height: 1.2;
            position: relative;
        }

        /* Blue Neon */
        .neon-blue {
            text-shadow:
                0 0 4px #fff, 0 0 10px #fff, 0 0 18px #fff,
                0 0 38px #22a7ff, 0 0 70px #22a7ff, 0 0 80px #22a7ff,
                0 0 90px #22a7ff, 0 0 140px #22a7ff;
            z-index: 2;
        }

        /* Pink Neon */
        .neon-pink {
            animation: flicker-pink 2s infinite alternate;
            z-index: 1;
        }
        
        @keyframes flicker-pink {
            0%, 18%, 22%, 25%, 53%, 57%, 100% {
                text-shadow:
                    0 0 4px #fff, 0 0 10px #fff, 0 0 18px #fff,
                    0 0 38px #ff26a8, 0 0 70px #ff26a8, 0 0 80px #ff26a8,
                    0 0 90px #ff26a8, 0 0 140px #ff26a8;
            }
            20%, 24%, 55% { text-shadow: none; }
        }

        /* Responsive Neon Title */
        .responsive-neon-title {
            font-size: clamp(2.5rem, 9vw, 6.5rem);
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            align-items: center;
            gap: 1.5rem 2.5rem; 
            padding: 0 1rem; 
        }

        .main-wrapper {
            background-image: url('https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/background.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        @media (max-width: 767px) {
            .main-wrapper {
                background-attachment: scroll;
            }
        }
        
        .glass-card {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-text {
            background: linear-gradient(to right, #34d399, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-200">
    
    <audio id="background-music" src="https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/titlemusic.wav" loop></audio>
    
    <div id="entryOverlay" class="fixed inset-0 bg-slate-900/90 z-[200] flex flex-col items-center justify-center text-white text-center p-4 transition-opacity duration-500">
        <h2 class="text-3xl md:text-5xl font-bold mb-4">ë°œë¦¬, ìš°ë¦¬ë¥¼ ìœ„í•œ ì™„ë²½í•œ í•˜ë£¨</h2>
        <p class="text-lg md:text-xl mb-8">ê°€ì¥ ê¸°ëŒ€ë˜ëŠ” ìˆœê°„ì— íˆ¬í‘œí•´ì£¼ì„¸ìš”.</p>
        <button id="enterBtn" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold py-3 px-8 rounded-full text-lg hover:from-emerald-600 hover:to-teal-600 transition-all shadow-lg shadow-emerald-500/30 hover:scale-105 flex items-center gap-3">
            <i class="fa-solid fa-music"></i>
            ì…ì¥ ë° ìŒì•… ì¬ìƒ
        </button>
        <p class="mt-6 text-sm text-gray-400">
            <i class="fa-solid fa-volume-high"></i> ë°°ê²½ ìŒì•…ì´ í•¨ê»˜ ì¬ìƒë©ë‹ˆë‹¤.
        </p>
    </div>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper min-h-screen">
        <div class="bg-black/60 min-h-screen">
            <!-- Header Section -->
            <header class="py-10 md:py-16 text-center text-white">
                <div class="logo-container mb-4">
                    <img src="https://github.com/incarmarketing/bali-vote-project/blob/main/logo.png?raw=true" alt="íšŒì‚¬ ë¡œê³ " class="company-logo h-12 mx-auto" onerror="this.style.display='none'">
                </div>
                <h1 class="responsive-neon-title">
                    <span class="neon-text neon-blue">incar high</span>
                    <span class="neon-text neon-pink">bali hi</span>
                </h1>
                <p class="mt-8 text-lg md:text-xl text-gray-200 max-w-2xl mx-auto px-4">
                    ë°œë¦¬ì—ì„œ ìƒê¸¸ ì¼, <br class="sm:hidden">ê°€ì¥ ê¸°ëŒ€í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”!
                </p>
            </header>

            <!-- Main Container -->
            <div class="container mx-auto px-4 pb-20">
                
                <!-- Admin Panel (hidden by default) -->
                <div id="adminPanel" class="hidden glass-card p-6 md:p-8 rounded-2xl shadow-xl mb-12">
                    <h2 class="text-2xl font-bold text-white mb-6">ğŸ”§ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
                    <form id="programForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="programTitle" class="block text-sm font-medium text-gray-300 mb-1">í”„ë¡œê·¸ë¨ ì´ë¦„</label>
                            <input type="text" id="programTitle" class="w-full p-3 bg-slate-800/70 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="ì˜ˆ: ìš°ë¶“ ë¼ì´ìŠ¤ í…Œë¼ìŠ¤ íˆ¬ì–´" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="programDescription" class="block text-sm font-medium text-gray-300 mb-1">í”„ë¡œê·¸ë¨ ì„¤ëª…</label>
                            <textarea id="programDescription" rows="4" class="w-full p-3 bg-slate-800/70 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="í”„ë¡œê·¸ë¨ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..." required></textarea>
                        </div>
                        <div>
                            <label for="programImage" class="block text-sm font-medium text-gray-300 mb-1">ì´ë¯¸ì§€ URL (í•„ìˆ˜)</label>
                            <input type="url" id="programImage" class="w-full p-3 bg-slate-800/70 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="https://example.com/image.jpg" required>
                        </div>
                        <div>
                            <label for="programVideo" class="block text-sm font-medium text-gray-300 mb-1">ë¹„ë””ì˜¤ URL (ì„ íƒ)</label>
                            <input type="url" id="programVideo" class="w-full p-3 bg-slate-800/70 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition" placeholder="https://example.com/video.mp4">
                        </div>
                        <div class="md:col-span-2 flex items-center gap-4 mt-4">
                            <button type="submit" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:from-emerald-600 hover:to-teal-600 transition-all shadow-md shadow-emerald-500/20 hover:shadow-lg">í”„ë¡œê·¸ë¨ ì¶”ê°€</button>
                            <button type="button" id="clearFormBtn" class="bg-slate-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-700 transition-all shadow-md hover:shadow-lg">ì…ë ¥ ì´ˆê¸°í™”</button>
                        </div>
                    </form>
                    <hr class="my-8 border-slate-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-2">ë°ì´í„° ê´€ë¦¬</h3>
                            <p class="text-sm text-gray-400 mb-4">í˜„ì¬ ëª©ë¡ì— ì—†ëŠ” ê¸°ë³¸ í”„ë¡œê·¸ë¨ì„ ì¶”ê°€í•©ë‹ˆë‹¤. ê¸°ì¡´ ë°ì´í„°ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                            <button type="button" id="addDefaultsBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-all shadow-md">ê¸°ë³¸ê°’ ì¶”ê°€</button>
                        </div>
                        <div class="bg-red-900/30 border border-red-500/30 p-4 rounded-lg">
                            <h3 class="text-xl font-bold text-red-400 mb-2">ğŸš¨ ìœ„í—˜ êµ¬ì—­</h3>
                            <p class="text-sm text-red-400 mb-4">DBì˜ ëª¨ë“  í”„ë¡œê·¸ë¨ ë° íˆ¬í‘œ ë°ì´í„°ê°€ ì‚­ì œë˜ê³  ê¸°ë³¸ê°’ìœ¼ë¡œ ë®ì–´ì”ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                            <button type="button" id="initDbBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-all shadow-md">DB ì´ˆê¸°í™”</button>
                        </div>
                    </div>
                </div>

                <!-- Results Section (hidden by default) -->
                <div id="resultsSection" class="hidden glass-card p-6 md:p-8 rounded-2xl shadow-xl mb-12">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white">ğŸ“Š ì‹¤ì‹œê°„ íˆ¬í‘œ ê²°ê³¼</h2>
                        <button id="excelDownloadBtn" class="hidden mt-4 md:mt-0 bg-green-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-700 transition-all shadow-md flex items-center gap-2">
                            <i class="fa-solid fa-file-excel"></i> ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                    <div id="resultsChart" class="space-y-5"></div>
                </div>

                <!-- Program Cards Grid -->
                <div id="programsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                <div id="noPrograms" class="text-center text-white bg-black/30 p-10 rounded-2xl">
                    í”„ë¡œê·¸ë¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
                </div>
            </div>
            
            <button id="adminToggleBtn" title="ì´ˆê¸°í™” ì¤‘..." disabled class="fixed bottom-4 right-4 w-10 h-10 md:w-12 md:h-12 bg-gray-600 text-white rounded-full shadow-lg hidden md:flex items-center justify-center z-50 text-lg md:text-xl transition-all hover:scale-110 hover:rotate-12 disabled:cursor-not-allowed disabled:bg-gray-400">
                <i class="fa-solid fa-screwdriver-wrench"></i>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="passwordModal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="modal-content bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl p-8 w-full max-w-md modal-appear">
            <h3 class="text-2xl font-bold text-white text-center mb-2">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
            <p class="text-center text-gray-400 mb-6">í”„ë¡œê·¸ë¨ì„ ê´€ë¦¬í•˜ë ¤ë©´ ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
            <input type="email" id="adminEmail" placeholder="ê´€ë¦¬ì ì´ë©”ì¼" class="w-full p-3 mb-4 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-emerald-500">
            <input type="password" id="adminPassword" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 mb-6 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-emerald-500">
            <div class="flex gap-4">
                <button id="loginBtn" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold py-3 rounded-lg hover:from-emerald-600 hover:to-teal-600 transition-all">ë¡œê·¸ì¸</button>
                <button onclick="hideModal('passwordModal')" class="w-full bg-slate-600 text-gray-200 font-bold py-3 rounded-lg hover:bg-slate-700 transition-all">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="voterAuthModal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="modal-content bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl p-8 w-full max-w-md modal-appear">
            <h3 class="text-2xl font-bold text-white text-center mb-2">ğŸ—³ï¸ íˆ¬í‘œì ì •ë³´ ì…ë ¥</h3>
            <p class="text-center text-gray-400 mb-6">íˆ¬í‘œëŠ” í•œ ì‚¬ëŒë‹¹ í•œ ë²ˆë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <input type="text" id="voterEmployeeId" placeholder="ì‚¬ë²ˆ" class="w-full p-3 mb-4 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-emerald-500">
            <input type="text" id="voterName" placeholder="ì´ë¦„" class="w-full p-3 mb-6 bg-slate-700 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-emerald-500">
            <div class="flex gap-4">
                <button id="submitVoteBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold py-3 rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all">íˆ¬í‘œí•˜ê¸°</button>
                <button onclick="hideModal('voterAuthModal')" class="w-full bg-slate-600 text-gray-200 font-bold py-3 rounded-lg hover:bg-slate-700 transition-all">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    
    <div id="voterListModal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="modal-content bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl p-8 w-full max-w-lg modal-appear">
            <h3 id="voterListTitle" class="text-2xl font-bold text-white text-center mb-6">íˆ¬í‘œì ëª…ë‹¨</h3>
            <ul id="voterList" class="h-64 overflow-y-auto bg-slate-900/50 p-4 rounded-lg border border-slate-700 text-gray-300"></ul>
            <div class="mt-6 text-center">
                <button onclick="hideModal('voterListModal')" class="bg-slate-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-slate-700 transition-all">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="modal-content bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl p-8 w-full max-w-md modal-appear text-center">
            <h3 id="alertTitle" class="text-2xl font-bold text-white mb-4">ì•Œë¦¼</h3>
            <p id="alertMessage" class="text-gray-300 mb-6"></p>
            <div id="alertButtons" class="flex gap-4 justify-center">
                <button id="alertOkBtn" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold py-2 px-8 rounded-lg hover:from-emerald-600 hover:to-teal-600 transition-all">í™•ì¸</button>
                <button id="alertCancelBtn" class="bg-slate-600 text-gray-200 font-bold py-2 px-8 rounded-lg hover:bg-slate-700 transition-all" style="display:none;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, increment, arrayUnion, onSnapshot, writeBatch, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables & Config ---
        let db, auth;
        let programs = [];
        let editingId = null, votingForId = null;
        let isAdminMode = false;
        let unsubscribePrograms = null;
        let videoObserver = null;
        let currentlyPlayingVideo = null;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
       const firebaseConfig = {
  apiKey: "AIzaSyDEcWo6Zf0R_0GtE51DryWNphkK1OjNzx0",
  authDomain: "incarhigh-balihi.firebaseapp.com",
  projectId: "incarhigh-balihi",
  storageBucket: "incarhigh-balihi.firebasestorage.app",
  messagingSenderId: "777053953777",
  appId: "1:777053953777:web:bd21c80707306f54da9350",
  measurementId: "G-T8BW822SLS"
};
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM Elements ---
        const programsGrid = document.getElementById('programsGrid');
        const noProgramsEl = document.getElementById('noPrograms');
        const programForm = document.getElementById('programForm');
        const adminToggleBtn = document.getElementById('adminToggleBtn');
        const resultsSection = document.getElementById('resultsSection');
        const adminPanel = document.getElementById('adminPanel');
        const excelDownloadBtn = document.getElementById('excelDownloadBtn');

        // --- Modal Helpers ---
        window.showModal = (id) => document.getElementById(id).classList.replace('hidden', 'flex');
        window.hideModal = (id) => document.getElementById(id).classList.replace('flex', 'hidden');

        // --- Custom Alert/Confirm ---
        const showAlert = (message, title = 'ì•Œë¦¼', onOk) => {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').innerHTML = message;
            const okBtn = document.getElementById('alertOkBtn');
            const cancelBtn = document.getElementById('alertCancelBtn');
            cancelBtn.style.display = 'none';
            
            okBtn.onclick = () => {
                hideModal('alertModal');
                if (onOk) onOk();
            };
            showModal('alertModal');
        };

        const showConfirm = (message, title = 'í™•ì¸ í•„ìš”') => {
            return new Promise((resolve) => {
                document.getElementById('alertTitle').textContent = title;
                document.getElementById('alertMessage').innerHTML = message;
                const okBtn = document.getElementById('alertOkBtn');
                const cancelBtn = document.getElementById('alertCancelBtn');
                cancelBtn.style.display = 'inline-block';

                okBtn.onclick = () => { hideModal('alertModal'); resolve(true); };
                cancelBtn.onclick = () => { hideModal('alertModal'); resolve(false); };
                showModal('alertModal');
            });
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            initializeFirebase();
        });

        async function initializeFirebase() {
            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    throw new Error("Firebase ì„¤ì •ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ë‚´ firebaseConfig ê°ì²´ë¥¼ ì±„ì›Œì£¼ì„¸ìš”.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                adminToggleBtn.disabled = false;
                adminToggleBtn.title = 'ê´€ë¦¬ì ëª¨ë“œ';
                adminToggleBtn.classList.replace('bg-gray-400', 'bg-emerald-500');
                console.log("Firebaseê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

                onAuthStateChanged(auth, user => {
                    isAdminMode = user && !user.isAnonymous;
                    adminPanel.classList.toggle('hidden', !isAdminMode);
                    resultsSection.classList.toggle('hidden', !isAdminMode);
                    excelDownloadBtn.classList.toggle('hidden', !isAdminMode);
                    renderPrograms();
                    updateResults();
                });
                
                loadAndListenPrograms();

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                showAlert(`Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. <br><br><b>ì˜¤ë¥˜: ${error.message}</b><br><br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•˜ì‹œê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`, "ì¹˜ëª…ì  ì˜¤ë¥˜");
                
                adminToggleBtn.disabled = true;
                adminToggleBtn.title = 'ì´ˆê¸°í™” ì‹¤íŒ¨!';
                adminToggleBtn.classList.add('bg-red-600');
                adminToggleBtn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>';
            }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.getElementById('enterBtn').addEventListener('click', () => {
                const overlay = document.getElementById('entryOverlay');
                const music = document.getElementById('background-music');
                
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 500);

                music.play().catch(error => {
                    console.warn("ë°°ê²½ìŒì•… ìë™ ì¬ìƒì´ ë¸Œë¼ìš°ì €ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.", error);
                });
            });

            adminToggleBtn.onclick = () => showModal('passwordModal');
            document.getElementById('loginBtn').onclick = checkAdminPassword;
            document.getElementById('clearFormBtn').onclick = clearForm;
            document.getElementById('initDbBtn').onclick = runInitialization;
            document.getElementById('addDefaultsBtn').onclick = addDefaultPrograms;
            document.getElementById('submitVoteBtn').onclick = submitVote;
            excelDownloadBtn.onclick = exportToExcel;
            programForm.addEventListener('submit', handleFormSubmit);
        }
        
        // --- Core App Logic ---
        function loadAndListenPrograms() {
            if (!db) return;
            const programsCollectionRef = collection(db, `artifacts/${appId}/public/data/programs`);
            
            if (unsubscribePrograms) unsubscribePrograms();

            unsubscribePrograms = onSnapshot(query(programsCollectionRef), (snapshot) => {
                programs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                programs.sort((a, b) => (a.order || 0) - (b.order || 0));
                
                if (programs.length === 0) {
                    noProgramsEl.textContent = 'í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•˜ì—¬ DBë¥¼ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”.';
                }
                
                renderPrograms();
                updateResults();
            }, (error) => {
                console.error("ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜:", error);
                showAlert(`ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. <br>ì˜¤ë¥˜: ${error.message}`, "ë°ì´í„° ì˜¤ë¥˜");
                noProgramsEl.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            });
        }

        function renderPrograms() {
            if (!programsGrid) return;
            
            const hasPrograms = programs && programs.length > 0;
            programsGrid.classList.toggle('hidden', !hasPrograms);
            noProgramsEl.classList.toggle('hidden', hasPrograms);

            if (!hasPrograms) return;

            programsGrid.innerHTML = programs.map(p => {
                const mediaElement = p.videoUrl
                    ? `<video class="program-media program-video w-full h-56 object-cover rounded-t-2xl" src="${p.videoUrl}" poster="${p.image}" muted loop playsinline preload="metadata"></video>`
                    : `<img src="${p.image || 'https://placehold.co/600x400/png?text=ì´ë¯¸ì§€+ì—†ìŒ'}" alt="${p.title}" class="w-full h-56 object-cover rounded-t-2xl" onerror="this.onerror=null; this.src='https://placehold.co/600x400/png?text=ì´ë¯¸ì§€+ì˜¤ë¥˜';">`;
                
                return `
                    <div class="program-card flex flex-col glass-card rounded-2xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300">
                        ${mediaElement}
                        <div class="p-6 flex flex-col flex-grow">
                            <h3 class="text-xl font-bold text-white mb-2">${p.title}</h3>
                            <p class="text-gray-400 text-sm leading-relaxed mb-4 flex-grow">${p.description}</p>
                            <div class="flex justify-between items-center pt-4 border-t border-slate-700">
                                <button class="vote-btn bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold py-2 px-5 rounded-full hover:from-emerald-600 hover:to-teal-600 transition-all shadow-md shadow-emerald-500/20 flex items-center gap-2" onclick="requestVote('${p.id}')">
                                    <i class="fa-solid fa-check-to-slot"></i> íˆ¬í‘œí•˜ê¸°
                                </button>
                                <span class="vote-count text-lg font-bold text-amber-400">${p.votes || 0}í‘œ</span>
                            </div>
                            <div class="admin-controls ${isAdminMode ? 'flex' : 'hidden'} gap-2 mt-4 pt-4 border-t border-dashed border-slate-600">
                                <button class="bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-blue-700 transition" onclick="editProgram('${p.id}')">ìˆ˜ì •</button>
                                <button class="bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-red-700 transition" onclick="deleteProgram('${p.id}')">ì‚­ì œ</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            setupVideoObserver();
        }
        
        function setupVideoObserver() {
            if (videoObserver) videoObserver.disconnect();
            
            const videos = document.querySelectorAll('.program-video');
            if (videos.length === 0) return;

            const options = {
                root: null,
                rootMargin: '0px',
                threshold: 0.6
            };

            videoObserver = new IntersectionObserver((entries) => {
                let mostVisibleEntry = null;
                let maxRatio = 0;

                entries.forEach(entry => {
                    if (entry.intersectionRatio > maxRatio) {
                        maxRatio = entry.intersectionRatio;
                        mostVisibleEntry = entry;
                    }
                });

                if (currentlyPlayingVideo && currentlyPlayingVideo !== mostVisibleEntry?.target) {
                    currentlyPlayingVideo.pause();
                    currentlyPlayingVideo = null;
                }

                if (mostVisibleEntry && mostVisibleEntry.isIntersecting) {
                    const videoToPlay = mostVisibleEntry.target;
                    if (videoToPlay !== currentlyPlayingVideo) {
                        videoToPlay.muted = true;
                        videoToPlay.play().catch(e => console.warn("Video play failed:", e));
                        currentlyPlayingVideo = videoToPlay;
                    }
                }

            }, options);

            videos.forEach(video => videoObserver.observe(video));
        }


        function updateResults() {
            const resultsChart = document.getElementById('resultsChart');
            if (!resultsChart || !isAdminMode) return;

            if (!programs || programs.length === 0) {
                resultsChart.innerHTML = '<p class="text-center text-gray-500">í‘œì‹œí•  íˆ¬í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            const totalVotes = programs.reduce((sum, p) => sum + (p.votes || 0), 0);

            resultsChart.innerHTML = `
                <div class="text-center mb-6">
                    <strong class="text-xl text-white">ì´ íˆ¬í‘œ ìˆ˜: <span class="gradient-text">${totalVotes}</span>í‘œ</strong>
                </div>
                <div class="space-y-5">
                ${programs.map(p => {
                    const percentage = totalVotes > 0 ? ((p.votes || 0) / totalVotes * 100).toFixed(1) : 0;
                    return `
                        <div>
                            <div class="flex justify-between items-center mb-1 text-gray-200">
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold">${p.title}</span>
                                    <button class="text-xs bg-slate-600 text-gray-300 px-2 py-0.5 rounded-md hover:bg-slate-700" onclick="showVoters('${p.id}')">íˆ¬í‘œì ë³´ê¸°</button>
                                </div>
                                <span class="text-sm font-medium">${p.votes || 0}í‘œ (${percentage}%)</span>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-4">
                                <div class="bg-gradient-to-r from-emerald-400 to-teal-500 h-4 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('')}
                </div>
            `;
        }

        // --- Vote Logic ---
        window.requestVote = (id) => {
            if (!db) return showAlert('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            votingForId = id;
            showModal('voterAuthModal');
            document.getElementById('voterEmployeeId').focus();
        };

        async function submitVote() {
            if (!db) return showAlert('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            const employeeId = document.getElementById('voterEmployeeId').value.trim();
            const name = document.getElementById('voterName').value.trim();
            if (!employeeId || !name) return showAlert('ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            const alreadyVoted = programs.some(p => p.voters?.some(v => v.id === employeeId));
            if (alreadyVoted) {
                hideModal('voterAuthModal');
                return showAlert('ì´ë¯¸ ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì— íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤. í•œ ì‚¬ëŒë‹¹ í•œ ë²ˆë§Œ íˆ¬í‘œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            
            try {
                const programRef = doc(db, `artifacts/${appId}/public/data/programs`, votingForId);
                await updateDoc(programRef, { 
                    votes: increment(1), 
                    voters: arrayUnion({ id: employeeId, name: name }) 
                });
                
                hideModal('voterAuthModal');
                document.getElementById('voterEmployeeId').value = '';
                document.getElementById('voterName').value = '';
                showAlert('íˆ¬í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'íˆ¬í‘œ ì™„ë£Œ');
            } catch (error) {
                console.error("íˆ¬í‘œ ì œì¶œ ì˜¤ë¥˜:", error);
                showAlert(`íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. <br>ì˜¤ë¥˜: ${error.message}`, "ì˜¤ë¥˜");
            }
        }

        // --- Admin Logic ---
        async function checkAdminPassword() {
            if (!auth) return showAlert('ì¸ì¦ ì„œë¹„ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'ì´ˆê¸°í™” ì¤‘');
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            if (!email || !password) return showAlert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                hideModal('passwordModal');
                showAlert('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ! ğŸ”“');
            } catch (error) {
                console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                showAlert(`ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.<br><br><b>ì˜¤ë¥˜:</b> ${error.code}`, 'ë¡œê·¸ì¸ ì˜¤ë¥˜');
            } finally {
                document.getElementById('adminPassword').value = '';
            }
        }
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!isAdminMode || !db) return showAlert('ê´€ë¦¬ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ê±°ë‚˜, DBê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            
            const title = document.getElementById('programTitle').value.trim();
            const description = document.getElementById('programDescription').value.trim();
            const image = document.getElementById('programImage').value.trim();
            const videoUrl = document.getElementById('programVideo').value.trim();
            if (!title || !description || !image) return showAlert('í”„ë¡œê·¸ë¨ ì´ë¦„, ì„¤ëª…, ì´ë¯¸ì§€ URLì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
            
            const programsCollectionRef = collection(db, `artifacts/${appId}/public/data/programs`);
            const data = { title, description, image, videoUrl };

            try {
                if (editingId) {
                    await updateDoc(doc(programsCollectionRef, editingId), data);
                    showAlert('í”„ë¡œê·¸ë¨ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    const maxOrder = programs.reduce((max, p) => Math.max(max, p.order || 0), 0);
                    await addDoc(programsCollectionRef, { ...data, votes: 0, voters: [], order: maxOrder + 1 });
                    showAlert('ìƒˆë¡œìš´ í”„ë¡œê·¸ë¨ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                clearForm();
            } catch (error) {
                console.error("í¼ ì œì¶œ ì˜¤ë¥˜:", error);
                showAlert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        function clearForm() {
            programForm.reset();
            editingId = null;
            document.querySelector('#programForm button[type="submit"]').textContent = 'í”„ë¡œê·¸ë¨ ì¶”ê°€';
        }

        window.editProgram = (id) => {
            if (!isAdminMode) return;
            const p = programs.find(prog => prog.id === id);
            if (p) {
                document.getElementById('programTitle').value = p.title;
                document.getElementById('programDescription').value = p.description.replace(/<br\s*\/?>/gi, '\n');
                document.getElementById('programImage').value = p.image || '';
                document.getElementById('programVideo').value = p.videoUrl || '';
                editingId = id;
                document.querySelector('#programForm button[type="submit"]').textContent = 'í”„ë¡œê·¸ë¨ ìˆ˜ì •';
                adminPanel.scrollIntoView({ behavior: 'smooth' });
            }
        };

        window.deleteProgram = async (id) => {
            if (!isAdminMode || !db) return;
            const confirmed = await showConfirm('ì •ë§ë¡œ ì´ í”„ë¡œê·¸ë¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  íˆ¬í‘œ ì •ë³´ê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.', 'ì‚­ì œ í™•ì¸');
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/programs`, id));
                    showAlert('í”„ë¡œê·¸ë¨ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
                    showAlert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            }
        };
        
        window.showVoters = (id) => {
            if (!isAdminMode) return;
            const p = programs.find(prog => prog.id === id);
            if (!p) return;
            const voterListEl = document.getElementById('voterList');
            document.getElementById('voterListTitle').textContent = `[${p.title}] íˆ¬í‘œì ëª…ë‹¨`;
            const voters = p.voters || [];
            voterListEl.innerHTML = voters.length 
                ? voters.map(v => `<li class="py-2 border-b border-slate-700 last:border-b-0">${v.name} (${v.id})</li>`).join('') 
                : '<li>ì•„ì§ íˆ¬í‘œí•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            showModal('voterListModal');
        };
        
        // --- Default Data Functions ---
        const defaultProgramsData = [
            { order: 1, title: 'ğŸ—¿ ê°€ë£¨ë‹¤ íŒŒí¬', description: 'ë°œë¦¬ ë¬¸í™”ì™€ íŒë‘êµ ë¬¸í™”ë¥¼ í•œë²ˆì— ë³´ê³ <br>ì›…ì¥í•œ ë°”ìœ„ë²½ê³¼ ì•„ë¦„ë‹¤ìš´ ì¸ê³µ ì—°ëª» ë“± <br>ë°œë¦¬ ìµœëŒ€ì˜ í…Œë§ˆ íŒŒí¬ë¥¼ ì¦ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 20ë¶„<br>ì´ìš©ì‹œê°„ : ì•½ 3ì‹œê°„', image: 'https://images.pexels.com/photos/13334227/pexels-photo-13334227.jpeg', videoUrl: '' },
            { order: 2, title: 'ğŸ¢ ì›Œí„°ë´„ ë°œë¦¬', description: 'ë°œë¦¬ ê¾¸ë”°ì— ìœ„ì¹˜í•œ ì¸ê¸° ì›Œí„°íŒŒí¬ì…ë‹ˆë‹¤.<br>ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ì›Œí„°ìŠ¬ë¼ì´ë“œì™€ ë‹¤ì–‘í•œ ì–´íŠ¸ë™ì…˜<br>ë‹¤ì–‘í•œ í¸ì˜ì‹œì„¤ì„ ë§ˆìŒê» ì¦ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 40ë¶„<br>ì´ìš©ì‹œê°„ : ì•½ 3ì‹œê°„', image: 'https://images.unsplash.com/photo-1741316041430-4e5362625ff2?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/program3.mp4' }, 
            { order: 3, title: 'ğŸ›ï¸ ê¾¸ë”°ë¹„ì¹˜ & ë¹„ì¹˜ì›Œí¬ ì‡¼í•‘ì„¼í„°', description: 'ë°œë¦¬ì˜ ëŒ€í‘œì ì¸ í•´ë³€ ê¾¸ë”°ë¹„ì¹˜ì—ì„œ<br>ì•„ë¦„ë‹¤ìš´ í•´ë³€ê³¼ ì—¬ìœ ë¥¼ ë§Œë½í•˜ê³ <br>ë©‹ì§„ ì „ê²½ì˜ ì‡¼í•‘ì„¼í„°ì—ì„œ í¸ì•ˆí•œ ì‡¼í•‘ì„ ì¦ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 40ë¶„<br>ì´ìš©ì‹œê°„ : ì•½ 5ì‹œê°„', image: 'https://cms.beachwalkbali.com/uploads/SUB_PROMOTION_WEB_eba6e4a9dd.jpg', videoUrl: '' },
            { order: 4, title: 'ğŸ–ï¸ ë¦¬ì¡°íŠ¸ ììœ ì¼ì •', description: '5ì„±ê¸‰ ê³ ê¸‰ í˜¸í…”ì˜ ìˆ˜ì˜ì¥ê³¼ ë¶€ëŒ€ì‹œì„¤ì„<br>ë§ˆìŒê» ì´ìš©í•˜ë©° ëˆ„êµ¬ì˜ ë°©í•´ë„ ë°›ì§€ ì•ŠëŠ”<br>ì™„ë²½í•œ ììœ ì‹œê°„ì„ ë§Œë½í•˜ì„¸ìš”.<br>ì´ë™ì‹œê°„ : ì—†ìŒ<br>ì´ìš©ì‹œê°„ : ììœ ', image: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/background.jpg', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/order4.mp4' },
            { order: 5, title: 'ğŸŒ´ ìš¸ë£¨ì™€ëšœ & ë”°ë‚˜ë°”ë½', description: 'ê²½ì´ë¡œìš´ ìì—°ê³¼ íŒë‘-ìë°” ì—­ì‚¬<br>ë…íŠ¹í•œ ê±´ì¶•ë¬¼ì´ ì–´ìš°ëŸ¬ì§„ ìš¸ë£¨ì™€íˆ¬ì™€<br>ì¸ìƒìƒ· ëª…ì†Œ ë”°ë‚˜ë°”ë½ ì ˆë²½ì„ ì°¾ì•„ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 50ë¶„<br>ì´ìš©ì‹œê°„ : ì•½ 3ì‹œê°„', image: 'https://images.unsplash.com/photo-1445968813835-7c9479a87d8b?q=80&w=1172&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: '' },
            { order: 6, title: 'ğŸŒï¸â€â™‚ï¸ ê³¨í”„', description: 'ë°œë¦¬ ë‰´ ê¾¸ë”° ê³¨í”„ í´ëŸ½ì—ì„œ<br>í™˜ìƒì ì¸ í•´ì•ˆì ˆê²½ì„ ê°ìƒí•˜ë©°<br>ìƒ‰ë‹¤ë¥¸ ë¼ìš´ë”©ì„ ì¦ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 40ë¶„<br>ì´ìš©ì‹œê°„ : ì•½ 5ì‹œê°„', image: 'https://images.unsplash.com/photo-1535131749006-b7f58c99034b?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/program4.mp4' },
            { order: 7, title: 'ğŸš£ ë˜í”„íŒ… & ìš°ë¶“', description: 'ì—´ëŒ€ìš°ë¦¼, ë©‹ì§„ í­í¬, ê¹ì•„ì§€ë¥¸ í˜‘ê³¡ì´ í¼ì³ì§„ ì•„ìœµê°•ì—ì„œ<br>ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ë˜í”„íŒ…ì„ ì¦ê¸°ê³ <br>ë°œë¦¬ì˜ ì˜ˆìˆ ê³¼ ë¬¸í™”, ì˜ì„±ì´ ì¡°í™”ë¡­ê²Œ ì–´ìš°ëŸ¬ì§„ ìš°ë¶“ì„ ë‘˜ëŸ¬ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 2ì‹œê°„ 30ë¶„<br>ì´ìš©ì‹œê°„ : ì•½ 2ì‹œê°„', image: 'https://cdn.pixabay.com/photo/2015/03/18/17/48/rafting-679719_1280.jpg', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/program1.mp4' },
            { order: 8, title: 'ğŸŒ¿ ë°œë¦¬ìŠ¤ìœ™ & ìš°ë¶“', description: 'ë°œë¦¬ì˜ í™˜ìƒì ì¸ ì •ê¸€ ì†ì—ì„œ ìœ ëª…í•œ ìŠ¤ìœ™ì„ ì¦ê¸°ë©°<br>ì´êµ­ì ì¸ í’ê²½ê³¼ ì¸ìƒ ì‚¬ì§„ì„ ë‚¨ê¸°ê³ <br>ë°œë¦¬ì˜ ì˜ˆìˆ ê³¼ ë¬¸í™”, ì˜ì„±ì´ ì¡°í™”ë¡­ê²Œ ì–´ìš°ëŸ¬ì§„ ìš°ë¶“ì„ ë‘˜ëŸ¬ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 2ì‹œê°„ 30ë¶„<br>ì´ìš©ì‹œê°„ : ì•½ 2ì‹œê°„', image: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/order8.png', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/program2.mp4' },
            { order: 9, title: 'ğŸ›• ìš°ë¶“ ììœ ê´€ê´‘', description: 'ë°œë¦¬ì˜ ì˜ˆìˆ ê³¼ ë¬¸í™” ì¤‘ì‹¬ì§€, ìš°ë¶“ì—ì„œ<br>ê³ ì¦ˆë„‰í•œ ì‚¬ì›ê³¼ ì™•ê¶ì„ ë‘˜ëŸ¬ë³´ê³ , í‘¸ë¥´ë¥¸ ê³„ë‹¨ì‹ ë…¼ ì‚¬ì´ë¥¼ ê±°ë‹ë©°<br>ë‹¹ì‹ ë§Œì˜ ì†ë„ë¡œ ìˆ¨ì€ ë§¤ë ¥ì„ ë°œê²¬í•´ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 2ì‹œê°„ 30ë¶„<br>ì´ìš©ì‹œê°„ : ì•½ 3ì‹œê°„', image: 'https://images.unsplash.com/photo-1644027621944-1aface1ae9f3?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/program9.mp4' },
            { order: 10, title: 'â›µ ì¸ì¹´ ë””ë„ˆ ì„ ì…‹í¬ë£¨ì¦ˆ', description: 'ì¸ë„ì–‘ì˜ ë¶‰ì€ ë…¸ì„ì„ ë°°ê²½ìœ¼ë¡œ<br>ì„ ìƒì—ì„œ í¼ì³ì§€ëŠ” ë‹¤ì–‘í•œ ê³µì—°ì„ ì¦ê¸°ë©°<br>ë°œë¦¬ì˜ ë°¤ë°”ë‹¤ê°€ ì„ ì‚¬í•˜ëŠ” ë‚­ë§Œì ì¸ ì¶”ì–µì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 1ì‹œê°„ 30ë¶„<br>ì´ìš©ì‹œê°„ : ì•½ 3ì‹œê°„', image: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/order10.png', videoUrl: '' },
        ];

        async function runInitialization() {
            if (!isAdminMode || !db) return showAlert('ê´€ë¦¬ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ê±°ë‚˜, DBê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            const confirmed = await showConfirm("ğŸš¨ ì •ë§ë¡œ ëª¨ë“  íˆ¬í‘œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ê¸°ë³¸ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!", "DB ì´ˆê¸°í™” í™•ì¸");
            if (!confirmed) return showAlert('ì´ˆê¸°í™”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');

            try {
                showAlert('DB ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...');
                const programsCollectionRef = collection(db, `artifacts/${appId}/public/data/programs`);
                
                const oldDocs = await getDocs(query(programsCollectionRef));
                const deleteBatch = writeBatch(db);
                oldDocs.forEach(doc => deleteBatch.delete(doc.ref));
                await deleteBatch.commit();
                
                const addBatch = writeBatch(db);
                defaultProgramsData.forEach(program => {
                    const newProgramRef = doc(programsCollectionRef);
                    addBatch.set(newProgramRef, { ...program, votes: 0, voters: [] });
                });
                await addBatch.commit();
                
                showAlert('ì´ˆê¸° ë°ì´í„° ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error("DB ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                showAlert(`DB ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.<br>ì˜¤ë¥˜: ${error.message}`);
            }
        }

        async function addDefaultPrograms() {
            if (!isAdminMode || !db) return showAlert('ê´€ë¦¬ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ê±°ë‚˜, DBê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            const confirmed = await showConfirm("ê¸°ë³¸ í”„ë¡œê·¸ë¨ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? <br>ì´ë¯¸ ëª©ë¡ì— ìˆëŠ” í”„ë¡œê·¸ë¨ì€ ì¤‘ë³µìœ¼ë¡œ ì¶”ê°€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€");
            if (!confirmed) return;

            try {
                showAlert('ê¸°ë³¸ í”„ë¡œê·¸ë¨ì„ ì¶”ê°€í•©ë‹ˆë‹¤...');
                const programsCollectionRef = collection(db, `artifacts/${appId}/public/data/programs`);
                const existingDocs = await getDocs(query(programsCollectionRef));
                const existingOrders = new Set(existingDocs.docs.map(doc => doc.data().order));

                const programsToAdd = defaultProgramsData.filter(p => !existingOrders.has(p.order));

                if (programsToAdd.length === 0) {
                    return showAlert('ëª¨ë“  ê¸°ë³¸ í”„ë¡œê·¸ë¨ì´ ì´ë¯¸ ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.', 'ì•Œë¦¼');
                }

                const addBatch = writeBatch(db);
                programsToAdd.forEach(program => {
                    const newProgramRef = doc(programsCollectionRef);
                    addBatch.set(newProgramRef, { ...program, votes: 0, voters: [] });
                });
                await addBatch.commit();

                showAlert(`${programsToAdd.length}ê°œì˜ ìƒˆë¡œìš´ ê¸°ë³¸ í”„ë¡œê·¸ë¨ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'ì¶”ê°€ ì™„ë£Œ');
            } catch (error) {
                console.error("ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€ ì˜¤ë¥˜:", error);
                showAlert(`ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // --- Excel Export ---
        function exportToExcel() {
            if (!isAdminMode) return showAlert('ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
            if (programs.length === 0) return showAlert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            
            showAlert('íˆ¬í‘œì ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œìš©ìœ¼ë¡œ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...');
            const allVoters = [];
            programs.forEach(p => {
                if (p.voters?.length) {
                    p.voters.forEach(v => allVoters.push({ program: p.title.replace(/,/g, ''), id: v.id, name: v.name }));
                }
            });
            
            if (!allVoters.length) return showAlert('ë‹¤ìš´ë¡œë“œí•  íˆ¬í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            
            const csv = `${"\uFEFF"}"í”„ë¡œê·¸ë¨","ì‚¬ë²ˆ","ì´ë¦„"\n${allVoters.map(v => `"${v.program}","${v.id}","${v.name}"`).join('\n')}`;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "bali_vote_results.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>
