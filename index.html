<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œë¦¬ ì—¬í–‰ í”„ë¡œê·¸ë¨ ì„ í˜¸ë„ ì¡°ì‚¬</title>

    <!-- ì†Œì…œ ê³µìœ ë¥¼ ìœ„í•œ Open Graph ë©”íƒ€ íƒœê·¸ -->
    <meta property="og:title" content="âœ¨ ë°œë¦¬ì—ì„œ ìƒê¸¸ ì¼ âœ¨">
    <meta property="og:description" content="â˜… ë°œë¦¬ ì—¬í–‰ ìµœê³ ì˜ í”„ë¡œê·¸ë¨ì„ ë½‘ì•„ì£¼ì„¸ìš” â˜…">
    <meta property="og:image" content="https://github.com/incarmarketing/bali-vote-project/blob/main/thumbnail.jpg?raw=true">
    <meta property="og:url" content="https://incarmarketing.github.io/bali-vote-project/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <style>
        /* ì¼ë°˜ ìŠ¤íƒ€ì¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1747235811701-c488682f5c7d?q=80&w=1150&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
            background-size: cover; background-position: center; background-attachment: fixed;
            min-height: 100vh;
        }
        
        /* ì¸íŠ¸ë¡œ ì˜ìƒ ìŠ¤í”Œë˜ì‹œ í™”ë©´ */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 1s ease-out;
        }
        #intro-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center; /* ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ì¤‘ì•™ ì •ë ¬ */
        }
        #skip-intro {
            position: absolute; bottom: 30px; right: 30px;
            background-color: rgba(0, 0, 0, 0.7); color: white;
            border: 1px solid white; padding: 10px 20px;
            border-radius: 20px; cursor: pointer; font-size: 14px; z-index: 10001;
        }
        
        /* ë©”ì¸ ì½˜í…ì¸  ë˜í¼ */
        .main-wrapper {
            padding: 20px; opacity: 0; /* ì²˜ìŒì—ëŠ” ìˆ¨ê¹€ */
            transition: opacity 1s ease-in;
        }
        .main-wrapper.visible { opacity: 1; }

        .logo-container { text-align: center; margin-bottom: 20px; }
        .company-logo { max-height: 60px; }
        
        /* ìŒì•… í† ê¸€ ë²„íŠ¼ */
        #music-toggle {
            position: fixed; bottom: 20px; left: 20px;
            background-color: rgba(0, 0, 0, 0.5); color: white;
            border: 1px solid white; width: 50px; height: 50px;
            border-radius: 50%; font-size: 24px; cursor: pointer;
            z-index: 1000; display: flex; justify-content: center; align-items: center;
        }

        /* í•µì‹¬ ë ˆì´ì•„ì›ƒ */
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, rgba(255,107,107,0.8), rgba(255,167,38,0.8)), url('https://images.unsplash.com/photo-1636619306699-2d27a100605e?q=80&w=1170&auto=format&fit=crop&ixlib-rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); background-size: cover; background-position: center; color: white; padding: 40px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .main-content { padding: 40px; padding-bottom: 100px; }
        
        /* ê´€ë¦¬ì íŒ¨ë„ */
        .admin-panel { background: #f8f9fa; border-radius: 15px; padding: 30px; margin-bottom: 40px; border: 2px dashed #dee2e6; display: none; }
        .admin-panel.show { display: block; }
        .admin-toggle { position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 15px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; transition: all 0.3s; }
        .admin-toggle:hover { transform: scale(1.1); }
        .admin-toggle:disabled {
            background: linear-gradient(135deg, #9E9E9E, #757575);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .admin-toggle:disabled:hover { transform: none; }
        .admin-toggle.failed { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .admin-panel h2 { color: #495057; margin-bottom: 20px; font-size: 1.5em; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        
        /* ë²„íŠ¼ */
        .btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-right: 10px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d, #495057); }
        
        /* í”„ë¡œê·¸ë¨ ì¹´ë“œ */
        .programs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-top: 30px; }
        .program-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; position: relative; }
        .program-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .program-media { width: 100%; height: 200px; object-fit: cover; background-color: #eee; }
        .program-content { padding: 25px; }
        .program-title { font-size: 1.3em; font-weight: 700; margin-bottom: 10px; color: #2c3e50; }
        .program-description { color: #7f8c8d; line-height: 1.6; margin-bottom: 20px; min-height: 75px; }
        .vote-section { display: flex; align-items: center; justify-content: space-between; padding-top: 20px; border-top: 1px solid #ecf0f1; }
        .vote-btn { background: linear-gradient(135deg, #00b894, #00cec9); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .vote-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3); }
        .vote-count { font-weight: 700; color: #2c3e50; font-size: 1.1em; }
        .admin-controls { display: none; gap: 10px; margin-top: 15px; }
        .admin-controls.show { display: flex; }

        /* ê²°ê³¼ ì„¹ì…˜ */
        .results-section { 
            background: #f8f9fa; 
            border-radius: 15px; 
            padding: 30px; 
            margin-top: 40px; 
            /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            /* display: none;  CSSì—ì„œ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì¤‘ë³µ ì œê±° */
        }
        .results-header { display: flex; justify-content: center; align-items: center; margin-bottom: 20px; position: relative; }
        .results-header h2 { color: #2c3e50; margin: 0; }
        .excel-download-btn { position: absolute; right: 0; background: linear-gradient(135deg, #28a745, #218838); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 14px; cursor: pointer; display: none; }
        .excel-download-btn.show { display: inline-block; }
        .no-programs { text-align: center; color: #7f8c8d; font-size: 1.1em; padding: 40px; }
        
        /* ëª¨ë‹¬ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%; text-align: center; animation: modal-appear 0.3s ease-out; }
        @keyframes modal-appear { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-content h3 { margin-bottom: 20px; color: #2c3e50; }
        .modal-content p { margin-bottom: 20px; color: #495057; line-height: 1.6; }
        .modal-content input { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; margin-bottom: 20px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        
        /* íˆ¬í‘œì ëª©ë¡ ëª¨ë‹¬ */
        .view-voters-btn { background: #6c757d; color: white; border: none; padding: 5px 10px; font-size: 12px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #voterList { list-style: none; text-align: left; max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; }
        #voterList li { padding: 8px; border-bottom: 1px solid #eee; }
        #voterList li:last-child { border-bottom: none; }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .main-wrapper { padding: 10px; }
            .header { padding: 30px 20px; }
            .header h1 { font-size: 2em; }
            .main-content { padding: 20px; padding-bottom: 100px; }
            .programs-grid { grid-template-columns: 1fr; }
            .results-header { flex-direction: column; gap: 15px; }
            .excel-download-btn { position: static; }
            #intro-video {
                object-position: 75% 50%;
            }
        }
    </style>
</head>
<body>
    <!-- ìŠ¤í”Œë˜ì‹œ í™”ë©´: ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ì™€ ê±´ë„ˆë›°ê¸° ë²„íŠ¼ì„ í¬í•¨ -->
    <div id="splash-screen">
        <video id="intro-video" src="https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/intro.mp4" autoplay muted playsinline></video>
        <button id="skip-intro">ì¸íŠ¸ë¡œ ê±´ë„ˆë›°ê¸° &gt;</button>
    </div>

    <!-- ë°°ê²½ ìŒì•…: ìë™ ì¬ìƒ ë° ë°˜ë³µ -->
    <audio id="background-music" src="https://cdn.pixabay.com/download/audio/2022/08/27/audio_2932470728.mp3" loop></audio>
    <!-- ìŒì•… í† ê¸€ ë²„íŠ¼ -->
    <button id="music-toggle">ğŸ”‡</button>

    <!-- ë©”ì¸ ì½˜í…ì¸  ë˜í¼ -->
    <div class="main-wrapper">
        <!-- íšŒì‚¬ ë¡œê³  ì»¨í…Œì´ë„ˆ -->
        <div class="logo-container">
            <img src="https://github.com/incarmarketing/bali-vote-project/blob/main/logo.png?raw=true" alt="íšŒì‚¬ ë¡œê³ " class="company-logo" onerror="this.style.display='none'">
        </div>

        <div class="container">
            <!-- í—¤ë” ì„¹ì…˜: ì œëª©ê³¼ ì„¤ëª… -->
            <div class="header">
                <h1>âœ¨ ë°œë¦¬ì—ì„œ ìƒê¸¸ ì¼ âœ¨</h1>
                <p>í•¨ê»˜ ë– ë‚  ë°œë¦¬ ì—¬í–‰<br>ìµœê³ ì˜ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”!</p>
            </div>
            <div class="main-content">
                <!-- ê´€ë¦¬ì íŒ¨ë„: í”„ë¡œê·¸ë¨ ì¶”ê°€/í¸ì§‘ ë° ë°ì´í„° ê´€ë¦¬ ê¸°ëŠ¥ -->
                <div class="admin-panel" id="adminPanel">
                    <h2>âœ¨ í”„ë¡œê·¸ë¨ ì¶”ê°€/í¸ì§‘</h2>
                    <form id="programForm">
                        <div class="form-group"><label for="programTitle">í”„ë¡œê·¸ë¨ ì´ë¦„</label><input type="text" id="programTitle" placeholder="ì˜ˆ: ìš°ë¶“ ë¼ì´ìŠ¤ í…Œë¼ìŠ¤ íˆ¬ì–´" required></div>
                        <div class="form-group"><label for="programDescription">í”„ë¡œê·¸ë¨ ì„¤ëª…</label><textarea id="programDescription" placeholder="í”„ë¡œê·¸ë¨ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..." required></textarea></div>
                        <div class="form-group"><label for="programImage">ì´ë¯¸ì§€ URL (í•„ìˆ˜)</label><input type="url" id="programImage" placeholder="https://example.com/image.jpg" required></div>
                        <div class="form-group"><label for="programVideo">ë¹„ë””ì˜¤ URL (ì„ íƒì‚¬í•­)</label><input type="url" id="programVideo" placeholder="https://example.com/video.mp4"></div>
                        <button type="submit" class="btn">í”„ë¡œê·¸ë¨ ì¶”ê°€</button>
                        <button type="button" class="btn btn-danger" id="clearFormBtn">ì…ë ¥ ì´ˆê¸°í™”</button>
                    </form>
                    <hr style="margin: 30px 0; border: 1px solid #eee;">
                    <h2 style="color: #495057;">âœ¨ ë°ì´í„° ê´€ë¦¬</h2>
                    <button type="button" class="btn" id="addDefaultsBtn">ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€</button>
                    <p style="font-size: 14px; color: #7f8c8d; margin-top: 10px; margin-bottom: 20px;">
                        í˜„ì¬ ëª©ë¡ì— ì—†ëŠ” ê¸°ë³¸ í”„ë¡œê·¸ë¨ì„ ì¶”ê°€í•©ë‹ˆë‹¤. ê¸°ì¡´ ë°ì´í„°ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </p>
                    <h2 style="color: #c0392b;">ğŸš¨ ìœ„í—˜ êµ¬ì—­ ğŸš¨</h2>
                    <button type="button" class="btn btn-danger" id="initDbBtn">DB ì´ˆê¸°í™” ë° ê¸°ë³¸ê°’ ì„¤ì •</button>
                    <p style="font-size: 14px; color: #7f8c8d; margin-top: 10px;">
                        ì£¼ì˜: ì´ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ DBì˜ ëª¨ë“  í”„ë¡œê·¸ë¨ì´ ì‚­ì œë˜ê³ , ì½”ë“œì— ì •ì˜ëœ ê¸°ë³¸ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ë®ì–´ì”ë‹ˆë‹¤.
                    </p>
                </div>
                
                <!-- í”„ë¡œê·¸ë¨ ì¹´ë“œ ê·¸ë¦¬ë“œ: íˆ¬í‘œ ê°€ëŠ¥í•œ í”„ë¡œê·¸ë¨ ëª©ë¡ í‘œì‹œ -->
                <div class="programs-grid" id="programsGrid"></div>
                <div class="no-programs" id="noPrograms">í”„ë¡œê·¸ë¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                
                <!-- ê²°ê³¼ ì„¹ì…˜: ì‹¤ì‹œê°„ íˆ¬í‘œ ê²°ê³¼ ì°¨íŠ¸ ë° ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
                <!-- ì´ ì„¹ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê²¨ì ¸ ìˆìœ¼ë©°, ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹œì—ë§Œ í‘œì‹œë©ë‹ˆë‹¤. -->
                <div class="results-section" id="resultsSection" style="display: none;">
                    <div class="results-header">
                        <h2>ğŸ“Š ì‹¤ì‹œê°„ íˆ¬í‘œ ê²°ê³¼</h2>
                        <button id="excelDownloadBtn" class="excel-download-btn">ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                    <div id="resultsChart"></div>
                </div>
            </div>
            <!-- ê´€ë¦¬ì í† ê¸€ ë²„íŠ¼ -->
            <button class="admin-toggle" id="adminToggleBtn" title="ì´ˆê¸°í™” ì¤‘..." disabled>ğŸ”§</button>
        </div>
    </div>

    <!-- ëª¨ë‹¬: ê´€ë¦¬ì ë¡œê·¸ì¸, íˆ¬í‘œì ì •ë³´ ì…ë ¥, íˆ¬í‘œì ëª…ë‹¨ ë³´ê¸°, ì¼ë°˜ ì•Œë¦¼/í™•ì¸ -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h3>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
            <p style="font-size:14px; color:#7f8c8d;">Firebase ì½˜ì†”ì—ì„œ ìƒì„±í•œ<br>ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
            <input type="email" id="adminEmail" placeholder="ê´€ë¦¬ì ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
            <input type="password" id="adminPassword" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <div class="modal-buttons">
                <button class="btn" id="loginBtn">ë¡œê·¸ì¸</button>
                <button class="btn btn-danger" onclick="hideModal('passwordModal')">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    <div class="modal" id="voterAuthModal">
        <div class="modal-content">
            <h3>ğŸ—³ï¸ íˆ¬í‘œì ì •ë³´ ì…ë ¥</h3>
            <input type="text" id="voterEmployeeId" placeholder="ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”">
            <input type="text" id="voterName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <div class="modal-buttons">
                <button class="btn" id="submitVoteBtn">íˆ¬í‘œí•˜ê¸°</button>
                <button class="btn btn-danger" onclick="hideModal('voterAuthModal')">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    <div class="modal" id="voterListModal">
        <div class="modal-content">
            <h3 id="voterListTitle">íˆ¬í‘œì ëª…ë‹¨</h3>
            <ul id="voterList"></ul>
            <div class="modal-buttons" style="margin-top: 20px;"><button class="btn btn-danger" onclick="hideModal('voterListModal')">ë‹«ê¸°</button></div>
        </div>
    </div>
    <!-- ì¼ë°˜ ì•Œë¦¼/í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal" id="alertModal">
        <div class="modal-content">
            <h3 id="alertTitle">ì•Œë¦¼</h3>
            <p id="alertMessage"></p>
            <div class="modal-buttons">
                <button class="btn" id="alertOkBtn">í™•ì¸</button>
                <button class="btn btn-secondary" id="alertCancelBtn" style="display:none;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase ëª¨ë“ˆ ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, increment, arrayUnion, onSnapshot, writeBatch, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ---
        let db; // Firestore ì¸ìŠ¤í„´ìŠ¤
        let auth; // Firebase Auth ì¸ìŠ¤í„´ìŠ¤
        let programs = []; // í”„ë¡œê·¸ë¨ ë°ì´í„° ë°°ì—´
        let editingId = null; // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ í”„ë¡œê·¸ë¨ ID
        let votingForId = null; // í˜„ì¬ íˆ¬í‘œí•˜ë ¤ëŠ” í”„ë¡œê·¸ë¨ ID
        let isAdminMode = false; // ê´€ë¦¬ì ëª¨ë“œ ì—¬ë¶€
        let unsubscribePrograms = null; // Firestore ìŠ¤ëƒ…ìƒ· ë¦¬ìŠ¤ë„ˆ í•´ì œ í•¨ìˆ˜
        let videoObserver = null; // Intersection Observer ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let isMainContentShown = false; // ë©”ì¸ ì½˜í…ì¸ ê°€ ì´ë¯¸ í‘œì‹œë˜ì—ˆëŠ”ì§€ ì¶”ì í•˜ëŠ” í”Œë˜ê·¸
        let introSkipTimeoutId; // âœ¨ ì¶”ê°€: ì¸íŠ¸ë¡œ ìë™ ê±´ë„ˆë›°ê¸° íƒ€ì´ë¨¸ IDë¥¼ ì €ì¥í•  ë³€ìˆ˜

        // Canvas í™˜ê²½ì—ì„œ ì œê³µë˜ëŠ” ì „ì—­ ë³€ìˆ˜ (Firebase ì„¤ì • ë° ì´ˆê¸° ì¸ì¦ í† í°)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // --- ì—¬ê¸°ì— Firebase í”„ë¡œì íŠ¸ ì„¤ì •ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš” ---
        // Firebase ì½˜ì†” > í”„ë¡œì íŠ¸ ì„¤ì • > ì¼ë°˜ > ë‚´ ì•± ì„¹ì…˜ì—ì„œ ì›¹ ì•±ì„ ì„ íƒí•˜ë©´ êµ¬ì„± ìŠ¤ë‹ˆí«ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
       const firebaseConfig = {
  apiKey: "AIzaSyDEcWo6Zf0R_0GtE51DryWNphkK1OjNzx0",
  authDomain: "incarhigh-balihi.firebaseapp.com",
  projectId: "incarhigh-balihi",
  storageBucket: "incarhigh-balihi.firebasestorage.app",
  messagingSenderId: "777053953777",
  appId: "1:777053953777:web:bd21c80707306f54da9350",
  measurementId: "G-T8BW822SLS"
};
        // ---------------------------------------------------
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM ìš”ì†Œ ---
        const splashScreen = document.getElementById('splash-screen');
        const introVideo = document.getElementById('intro-video');
        const mainWrapper = document.querySelector('.main-wrapper');
        const music = document.getElementById('background-music');
        const programsGrid = document.getElementById('programsGrid');
        const noProgramsEl = document.getElementById('noPrograms');
        const programForm = document.getElementById('programForm');
        const adminToggleBtn = document.getElementById('adminToggleBtn');
        const resultsSection = document.getElementById('resultsSection'); // ê²°ê³¼ ì„¹ì…˜ DOM ìš”ì†Œ ì¶”ê°€

        // --- ëª¨ë‹¬ ë„ìš°ë¯¸ í•¨ìˆ˜ ---
        // íŠ¹ì • IDì˜ ëª¨ë‹¬ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        window.showModal = (id) => document.getElementById(id).classList.add('show');
        // íŠ¹ì • IDì˜ ëª¨ë‹¬ì„ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
        window.hideModal = (id) => document.getElementById(id).classList.remove('show');

        // --- ì»¤ìŠ¤í…€ ì•Œë¦¼/í™•ì¸ ì°½ (alert, confirm ëŒ€ì²´) ---
        /**
         * ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” ì»¤ìŠ¤í…€ ëª¨ë‹¬
         * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€ (HTML í¬í•¨ ê°€ëŠ¥)
         * @param {string} [title='ì•Œë¦¼'] - ëª¨ë‹¬ ì œëª©
         * @param {function} [onOk] - 'í™•ì¸' ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  ì½œë°± í•¨ìˆ˜
         */
        const showAlert = (message, title = 'ì•Œë¦¼', onOk) => {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').innerHTML = message;
            const okBtn = document.getElementById('alertOkBtn');
            const cancelBtn = document.getElementById('alertCancelBtn');
            cancelBtn.style.display = 'none'; // ì•Œë¦¼ ëª¨ë‹¬ì—ì„œëŠ” ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¹€
            
            okBtn.onclick = () => {
                hideModal('alertModal');
                if (onOk) onOk();
            };
            showModal('alertModal');
        };

        /**
         * ì‚¬ìš©ìì—ê²Œ í™•ì¸ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  ì‘ë‹µì„ ë°›ëŠ” ì»¤ìŠ¤í…€ ëª¨ë‹¬
         * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€ (HTML í¬í•¨ ê°€ëŠ¥)
         * @param {string} [title='í™•ì¸ í•„ìš”'] - ëª¨ë‹¬ ì œëª©
         * @returns {Promise<boolean>} - ì‚¬ìš©ìê°€ 'í™•ì¸'ì„ ëˆ„ë¥´ë©´ true, 'ì·¨ì†Œ'ë¥¼ ëˆ„ë¥´ë©´ falseë¥¼ ë°˜í™˜í•˜ëŠ” Promise
         */
        const showConfirm = (message, title = 'í™•ì¸ í•„ìš”') => {
            return new Promise((resolve) => {
                document.getElementById('alertTitle').textContent = title;
                document.getElementById('alertMessage').innerHTML = message;
                const okBtn = document.getElementById('alertOkBtn');
                const cancelBtn = document.getElementById('alertCancelBtn');
                cancelBtn.style.display = 'inline-block'; // í™•ì¸ ëª¨ë‹¬ì—ì„œëŠ” ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ

                okBtn.onclick = () => { hideModal('alertModal'); resolve(true); };
                cancelBtn.onclick = () => { hideModal('alertModal'); resolve(false); };
                showModal('alertModal');
            });
        };

        // --- ì´ˆê¸°í™” í•¨ìˆ˜ ---
        // DOM ë¡œë“œ ì™„ë£Œ í›„ Firebase ì´ˆê¸°í™”, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •, ìŒì•… ë° ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ ì¬ìƒ
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
            playMusic();
            playIntroVideo();
        });

        // Firebase ì´ˆê¸°í™” í•¨ìˆ˜
        async function initializeFirebase() {
            try {
                // Firebase ì„¤ì • ê°ì²´ê°€ ìœ íš¨í•œì§€ í™•ì¸
                // ì´ì œ ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ firebaseConfigë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    throw new Error("Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ë‚´ firebaseConfigë¥¼ í™•ì¸í•˜ê³  ì±„ì›Œì£¼ì„¸ìš”.");
                }

                // Firebase ì•± ì´ˆê¸°í™”
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app); // Firestore ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
                auth = getAuth(app); // Auth ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°

                // ì´ˆê¸° ì¸ì¦ í† í°ì´ ìˆìœ¼ë©´ ì»¤ìŠ¤í…€ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸, ì—†ìœ¼ë©´ ìµëª… ë¡œê·¸ì¸
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // ê´€ë¦¬ì í† ê¸€ ë²„íŠ¼ í™œì„±í™”
                adminToggleBtn.disabled = false;
                adminToggleBtn.title = 'ê´€ë¦¬ì ëª¨ë“œ';
                console.log("Firebaseê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥.");

                // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€ ë¦¬ìŠ¤ë„ˆ
                // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ê±°ë‚˜ ë¡œê·¸ì•„ì›ƒí•  ë•Œë§ˆë‹¤ í˜¸ì¶œë¨
                onAuthStateChanged(auth, user => {
                    // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í–ˆê³  ìµëª… ì‚¬ìš©ìê°€ ì•„ë‹ˆë©´ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”
                    if (user && !user.isAnonymous) {
                        isAdminMode = true;
                        document.getElementById('adminPanel').classList.add('show'); // ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œ
                        document.getElementById('excelDownloadBtn').classList.add('show'); // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
                        resultsSection.style.display = 'block'; // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
                    } else {
                        // ê´€ë¦¬ì ëª¨ë“œ ë¹„í™œì„±í™”
                        isAdminMode = false;
                        document.getElementById('adminPanel').classList.remove('show'); // ê´€ë¦¬ì íŒ¨ë„ ìˆ¨ê¹€
                        document.getElementById('excelDownloadBtn').classList.remove('show'); // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìˆ¨ê¹€
                        resultsSection.style.display = 'none'; // ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¹€
                    }
                    renderPrograms(); // í”„ë¡œê·¸ë¨ ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§ (ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ í‘œì‹œ/ìˆ¨ê¹€)
                    updateResults(); // íˆ¬í‘œ ê²°ê³¼ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ì ì •ë³´ í‘œì‹œ/ìˆ¨ê¹€)
                });
                
                // í”„ë¡œê·¸ë¨ ë°ì´í„° ë¡œë“œ ë° ì‹¤ì‹œê°„ ê°ì§€ ì‹œì‘
                loadAndListenPrograms();

            } catch (error) {
                // Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ì²˜ë¦¬
                console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                showAlert(`Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. <br><br><b>ì˜¤ë¥˜: ${error.message}</b><br><br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•˜ì‹œê±°ë‚˜, ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`, "ì¹˜ëª…ì  ì˜¤ë¥˜");
                
                // ê´€ë¦¬ì í† ê¸€ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
                adminToggleBtn.disabled = true;
                adminToggleBtn.title = 'ì´ˆê¸°í™” ì‹¤íŒ¨! ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.';
                adminToggleBtn.classList.add('failed');
                adminToggleBtn.innerHTML = 'âŒ';
            }
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        function setupEventListeners() {
            // âœ¨ ìˆ˜ì •: ì¸íŠ¸ë¡œ ê±´ë„ˆë›°ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œì§ ë³€ê²½
            document.getElementById('skip-intro').onclick = () => {
                if (introSkipTimeoutId) {
                    clearTimeout(introSkipTimeoutId); // ìë™ ê±´ë„ˆë›°ê¸° íƒ€ì´ë¨¸ ì·¨ì†Œ
                }
                introVideo.pause(); // ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ì§€
                showMainContent(); // ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
            };
            // ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ ì¢…ë£Œ ì‹œ ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
            introVideo.onended = showMainContent;
            
            // ë¹„ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜ ì‹œì—ë„ ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
            introVideo.addEventListener('error', (e) => {
                console.error("ë¹„ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜:", e);
                if (introSkipTimeoutId) {
                    clearTimeout(introSkipTimeoutId); // ì˜¤ë¥˜ ë°œìƒ ì‹œ íƒ€ì´ë¨¸ ì·¨ì†Œ
                }
                showMainContent(); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜
            });

            // ìŒì•… í† ê¸€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('music-toggle').addEventListener('click', toggleMusic);
            // ê´€ë¦¬ì í† ê¸€ ë²„íŠ¼ í´ë¦­ ì‹œ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ í‘œì‹œ
            adminToggleBtn.onclick = () => showModal('passwordModal');
            // ê´€ë¦¬ì ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('loginBtn').onclick = checkAdminPassword;
            // í”„ë¡œê·¸ë¨ ì¶”ê°€/í¸ì§‘ í¼ ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('clearFormBtn').onclick = clearForm;
            // DB ì´ˆê¸°í™” ë° ê¸°ë³¸ê°’ ì„¤ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('initDbBtn').onclick = runInitialization;
            // ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('addDefaultsBtn').onclick = addDefaultPrograms;
            // íˆ¬í‘œ ì œì¶œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('submitVoteBtn').onclick = submitVote;
            // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document.getElementById('excelDownloadBtn').onclick = exportToExcel;
            // í”„ë¡œê·¸ë¨ ì¶”ê°€/í¸ì§‘ í¼ ì œì¶œ ì´ë²¤íŠ¸
            programForm.addEventListener('submit', handleFormSubmit);
        }

        // --- ì¸íŠ¸ë¡œ ë° ìŒì•… ê´€ë ¨ í•¨ìˆ˜ ---
        // ë°°ê²½ ìŒì•… ì¬ìƒ ì‹œë„
        function playMusic() {
            music.muted = true; // ì´ˆê¸°ì—ëŠ” ìŒì†Œê±°
            music.play().catch(error => {
                console.warn('ìŒì•… ìë™ ì¬ìƒ ì‹¤íŒ¨. ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.', error);
                // ìë™ ì¬ìƒì´ ì‹¤íŒ¨í•˜ë©´ ì‚¬ìš©ì í´ë¦­ ì‹œ ì¬ìƒë˜ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                document.body.addEventListener('click', () => {
                    if (music.paused) music.play();
                }, { once: true }); // í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •
            });
        }

        // ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
        function playIntroVideo() {
            // âœ¨ ìˆ˜ì •: ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ ë¨¼ì € ì·¨ì†Œ
            if (introSkipTimeoutId) {
                clearTimeout(introSkipTimeoutId);
            }

            // ë¹„ë””ì˜¤ ìë™ ê±´ë„ˆë›°ê¸° íƒ€ì´ë¨¸ ì„¤ì • (5ì´ˆ í›„)
            introSkipTimeoutId = setTimeout(() => {
                console.warn("ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ ìë™ ì¬ìƒ ì‹¤íŒ¨ ë˜ëŠ” ì§€ì—°, 5ì´ˆ í›„ ë©”ì¸ ì½˜í…ì¸ ë¡œ ìë™ ì „í™˜.");
                showMainContent();
            }, 5000); // 5ì´ˆ

            const playPromise = introVideo.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    clearTimeout(introSkipTimeoutId); // ë¹„ë””ì˜¤ ì¬ìƒ ì„±ê³µ ì‹œ íƒ€ì´ë¨¸ ì·¨ì†Œ
                    console.log("ì¸íŠ¸ë¡œ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘, ìŒì•… ìŒì†Œê±° í•´ì œ.");
                    music.muted = false; // ë¹„ë””ì˜¤ ì¬ìƒ ì„±ê³µ ì‹œ ìŒì•… ìŒì†Œê±° í•´ì œ
                    document.getElementById('music-toggle').textContent = 'ğŸ”Š'; // ìŒì•… ì•„ì´ì½˜ ë³€ê²½
                }).catch(error => {
                    clearTimeout(introSkipTimeoutId); // âœ¨ ìˆ˜ì •: ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨ ì‹œì—ë„ íƒ€ì´ë¨¸ ì·¨ì†Œ
                    console.warn("ì˜ìƒ ìë™ ì¬ìƒ ì‹¤íŒ¨. ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.", error);
                    // âœ¨ ë³€ê²½: ìë™ ì¬ìƒ ì‹¤íŒ¨ ì‹œ showMainContent()ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ.
                    // ì‚¬ìš©ìê°€ 'ê±´ë„ˆë›°ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜, ë¹„ë””ì˜¤ ìì²´ë¥¼ í´ë¦­í•  ë•Œê¹Œì§€ ìŠ¤í”Œë˜ì‹œ í™”ë©´ ìœ ì§€.
                    // 5ì´ˆ ìë™ ì „í™˜ íƒ€ì´ë¨¸ëŠ” ì—¬ì „íˆ ì‘ë™í•˜ì—¬ ìµœì¢… í´ë°± ì—­í• ì„ í•¨.
                    splashScreen.addEventListener('click', () => {
                        introVideo.play();
                        music.muted = false;
                        document.getElementById('music-toggle').textContent = 'ğŸ”Š';
                    }, { once: true });
                });
            } else {
                // playPromiseê°€ undefinedì¸ ê²½ìš° (êµ¬í˜• ë¸Œë¼ìš°ì € ë“±) ì¦‰ì‹œ ë©”ì¸ ì½˜í…ì¸ ë¡œ ì „í™˜
                clearTimeout(introSkipTimeoutId);
                showMainContent();
            }
        }
        
        // ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ ë° ìŠ¤í”Œë˜ì‹œ í™”ë©´ ìˆ¨ê¹€
        function showMainContent() {
            if (isMainContentShown) return; // ì´ë¯¸ ë©”ì¸ ì½˜í…ì¸ ê°€ í‘œì‹œë˜ì—ˆìœ¼ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            isMainContentShown = true; // í”Œë˜ê·¸ ì„¤ì •

            splashScreen.style.opacity = '0'; // ìŠ¤í”Œë˜ì‹œ í™”ë©´ íˆ¬ëª…í•˜ê²Œ
            setTimeout(() => {
                splashScreen.style.display = 'none'; // íˆ¬ëª…í•´ì§„ í›„ ìˆ¨ê¹€
                mainWrapper.classList.add('visible'); // ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
            }, 1000); // 1ì´ˆ í›„ ì‹¤í–‰ (CSS transition ì‹œê°„ê³¼ ì¼ì¹˜)
        }
        
        // ìŒì•… ì¬ìƒ/ì •ì§€ í† ê¸€
        function toggleMusic() {
            music.muted = !music.muted; // ìŒì†Œê±° ìƒíƒœ ë°˜ì „
            document.getElementById('music-toggle').textContent = music.muted ? 'ğŸ”‡' : 'ğŸ”Š'; // ì•„ì´ì½˜ ë³€ê²½
        }

        // --- í•µì‹¬ ì•± ë¡œì§ ---
        // Firestoreì—ì„œ í”„ë¡œê·¸ë¨ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³  ì‹¤ì‹œê°„ ë³€ê²½ì„ ê°ì§€
        function loadAndListenPrograms() {
            if (!db) return; // DBê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ
            // Firestore ì»¬ë ‰ì…˜ ì°¸ì¡° (public/data ê²½ë¡œ ì‚¬ìš©)
            const programsCollectionRef = collection(db, `artifacts/${appId}/public/data/programs`);
            
            // ê¸°ì¡´ ìŠ¤ëƒ…ìƒ· ë¦¬ìŠ¤ë„ˆê°€ ìˆë‹¤ë©´ í•´ì œ
            if (unsubscribePrograms) unsubscribePrograms();

            // ì‹¤ì‹œê°„ ìŠ¤ëƒ…ìƒ· ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            unsubscribePrograms = onSnapshot(query(programsCollectionRef), (querySnapshot) => {
                programs = []; // í”„ë¡œê·¸ë¨ ë°°ì—´ ì´ˆê¸°í™”
                if (querySnapshot.empty) {
                    // í”„ë¡œê·¸ë¨ì´ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
                    noProgramsEl.textContent = 'í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•˜ì—¬ DBë¥¼ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”.';
                } else {
                    // ìŠ¤ëƒ…ìƒ·ì˜ ê° ë¬¸ì„œë¥¼ í”„ë¡œê·¸ë¨ ë°°ì—´ì— ì¶”ê°€
                    querySnapshot.forEach((doc) => {
                        programs.push({ id: doc.id, ...doc.data() });
                    });
                    // 'order' í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í”„ë¡œê·¸ë¨ ì •ë ¬
                    programs.sort((a, b) => (a.order || 0) - (b.order || 0));
                }
                renderPrograms(); // í”„ë¡œê·¸ë¨ ëª©ë¡ ë Œë”ë§
                updateResults(); // íˆ¬í‘œ ê²°ê³¼ ì—…ë°ì´íŠ¸
            }, (error) => {
                // ë°ì´í„° ìˆ˜ì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì²˜ë¦¬
                console.error("ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜:", error);
                showAlert(`ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. <br><br>ì˜¤ë¥˜: ${error.message}`, "ë°ì´í„° ì˜¤ë¥˜");
                noProgramsEl.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            });
        }

        // í”„ë¡œê·¸ë¨ ì¹´ë“œ ë Œë”ë§
        function renderPrograms() {
            if (!programsGrid) return; // DOM ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
            if (!programs || programs.length === 0) {
                // í”„ë¡œê·¸ë¨ì´ ì—†ìœ¼ë©´ ê·¸ë¦¬ë“œ ìˆ¨ê¸°ê³  ë©”ì‹œì§€ í‘œì‹œ
                programsGrid.style.display = 'none';
                noProgramsEl.style.display = 'block';
                return;
            }
            // í”„ë¡œê·¸ë¨ì´ ìˆìœ¼ë©´ ê·¸ë¦¬ë“œ í‘œì‹œí•˜ê³  ë©”ì‹œì§€ ìˆ¨ê¹€
            programsGrid.style.display = 'grid';
            noProgramsEl.style.display = 'none';

            // í”„ë¡œê·¸ë¨ ë°ì´í„°ë¥¼ HTML ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ê·¸ë¦¬ë“œì— ì‚½ì…
            programsGrid.innerHTML = programs.map(p => {
                // ë¹„ë””ì˜¤ URLì´ ìˆìœ¼ë©´ ë¹„ë””ì˜¤ íƒœê·¸, ì—†ìœ¼ë©´ ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
                const mediaElement = p.videoUrl
                    ? `<video class="program-media program-video" src="${p.videoUrl}" poster="${p.image}" muted loop playsinline></video>`
                    : `<img src="${p.image || 'https://placehold.co/400x200/png?text=ì´ë¯¸ì§€+ì—†ìŒ'}" alt="${p.title}" class="program-media" onerror="this.onerror=null; this.src='https://placehold.co/400x200/png?text=ì´ë¯¸ì§€+ì˜¤ë¥˜';">`;

                return `
                    <div class="program-card">
                        ${mediaElement}
                        <div class="program-content">
                            <h3 class="program-title">${p.title}</h3>
                            <p class="program-description">${p.description}</p>
                            <div class="vote-section">
                                <button class="vote-btn" onclick="requestVote('${p.id}')">ğŸ‘ ì´ í”„ë¡œê·¸ë¨ ì„ íƒ</button>
                                <span class="vote-count">${p.votes || 0}í‘œ</span>
                            </div>
                            <div class="admin-controls ${isAdminMode ? 'show' : ''}">
                                <button class="btn" onclick="editProgram('${p.id}')">ìˆ˜ì •</button>
                                <button class="btn btn-danger" onclick="deleteProgram('${p.id}')">ì‚­ì œ</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // ë Œë”ë§ì´ ëë‚œ í›„ ë¹„ë””ì˜¤ ê°ì‹œì ì„¤ì • (ìƒˆë¡œ ì¶”ê°€ëœ ë¹„ë””ì˜¤ ìš”ì†Œë“¤ì„ ê°ì‹œ)
            setupVideoObserver();
        }

        // í™”ë©´ì— ë³´ì´ëŠ” ë¹„ë””ì˜¤ë¥¼ ê°ì§€í•˜ê³  ì¬ìƒ/ì •ì§€í•˜ëŠ” í•¨ìˆ˜ (Intersection Observer ì‚¬ìš©)
        function setupVideoObserver() {
            // ê¸°ì¡´ ê°ì‹œìê°€ ìˆë‹¤ë©´ ì—°ê²° í•´ì œ
            if (videoObserver) {
                videoObserver.disconnect();
            }

            const options = {
                root: null, // ë·°í¬íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°ì‹œ
                rootMargin: '0px',
                threshold: 0.75 // ë¹„ë””ì˜¤ì˜ 75% ì´ìƒì´ ë³´ì¼ ë•Œ ì½œë°± ì‹¤í–‰
            };

            const handleIntersection = (entries) => {
                entries.forEach(entry => {
                    const video = entry.target;
                    if (entry.isIntersecting) {
                        // í™”ë©´ì— ë³´ì´ë©´ ì¬ìƒ
                        video.play().catch(e => console.log("Video play failed:", e));
                    } else {
                        // í™”ë©´ì—ì„œ ì‚¬ë¼ì§€ë©´ ì •ì§€
                        video.pause();
                    }
                });
            };

            videoObserver = new IntersectionObserver(handleIntersection, options);

            // '.program-video' í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ëª¨ë“  ë¹„ë””ì˜¤ë¥¼ ê°ì‹œ ëŒ€ìƒìœ¼ë¡œ ë“±ë¡
            const videos = document.querySelectorAll('.program-video');
            videos.forEach(video => videoObserver.observe(video));
        }

        // íˆ¬í‘œ ê²°ê³¼ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateResults() {
            const resultsChart = document.getElementById('resultsChart');
            if (!resultsChart) return; // DOM ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
            
            // ì´ í•¨ìˆ˜ëŠ” ì´ì œ resultsSectionì˜ display ì†ì„±ì„ ì§ì ‘ ì œì–´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            // onAuthStateChangedì—ì„œ resultsSectionì˜ í‘œì‹œ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.

            if (!programs || programs.length === 0) {
                resultsChart.innerHTML = '<div class="no-programs">íˆ¬í‘œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>';
                return;
            }
            const totalVotes = programs.reduce((sum, p) => sum + (p.votes || 0), 0);
            
            resultsChart.innerHTML = `
                <div style="margin-bottom: 20px; text-align: center;"><strong>ì´ íˆ¬í‘œ ìˆ˜: ${totalVotes}í‘œ</strong></div>
                ${programs.map(p => {
                    const percentage = totalVotes > 0 ? ((p.votes || 0) / totalVotes * 100).toFixed(1) : 0;
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div>
                                    <span style="font-weight: 600;">${p.title}</span>
                                    <!-- ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œë§Œ íˆ¬í‘œì ë³´ê¸° ë²„íŠ¼ í‘œì‹œ -->
                                    ${isAdminMode ? `<button class="view-voters-btn" onclick="showVoters('${p.id}')">íˆ¬í‘œì ë³´ê¸°</button>` : ''}
                                </div>
                                <span style="color: #7f8c8d;">${p.votes || 0}í‘œ (${percentage}%)</span>
                            </div>
                            <div style="background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${percentage}%; transition: width 0.5s ease-in-out;"></div>
                            </div>
                        </div>`;
                }).join('')}
            `;
            // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì€ onAuthStateChangedì—ì„œ ì œì–´ë˜ë¯€ë¡œ ì—¬ê¸°ì„œ ì§ì ‘ ì œì–´í•  í•„ìš” ì—†ìŒ
        }

        // --- íˆ¬í‘œ ë¡œì§ ---
        // íˆ¬í‘œ ìš”ì²­ ì‹œ íˆ¬í‘œì ì •ë³´ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
        window.requestVote = (id) => {
            if (!db) return showAlert('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            votingForId = id; // íˆ¬í‘œí•˜ë ¤ëŠ” í”„ë¡œê·¸ë¨ ID ì €ì¥
            showModal('voterAuthModal'); // íˆ¬í‘œì ì¸ì¦ ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('voterEmployeeId').focus(); // ì‚¬ë²ˆ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
        };

        // íˆ¬í‘œ ì œì¶œ ì²˜ë¦¬
        async function submitVote() {
            if (!db) return showAlert('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            const employeeId = document.getElementById('voterEmployeeId').value.trim();
            const name = document.getElementById('voterName').value.trim();
            if (!employeeId || !name) {
                return showAlert('ì‚¬ë²ˆê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); // í•„ìˆ˜ í•„ë“œ ê²€ì¦
            }
            
            // ì´ë¯¸ íˆ¬í‘œí–ˆëŠ”ì§€ í™•ì¸ (ëª¨ë“  í”„ë¡œê·¸ë¨ì˜ íˆ¬í‘œì ëª©ë¡ì„ ìˆœíšŒ)
            const alreadyVoted = programs.some(p => p.voters?.some(v => v.id === employeeId));
            if (alreadyVoted) {
                hideModal('voterAuthModal');
                return showAlert('ì´ë¯¸ ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì— íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤. í•œ ì‚¬ëŒë‹¹ í•œ ë²ˆë§Œ íˆ¬í‘œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            
            try {
                const programRef = doc(db, `artifacts/${appId}/public/data/programs`, votingForId);
                // íˆ¬í‘œ ìˆ˜ ì¦ê°€ ë° íˆ¬í‘œì ì •ë³´ ì¶”ê°€ (arrayUnionìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€)
                await updateDoc(programRef, { 
                    votes: increment(1), 
                    voters: arrayUnion({ id: employeeId, name: name }) 
                });
                
                hideModal('voterAuthModal'); // ëª¨ë‹¬ ìˆ¨ê¹€
                document.getElementById('voterEmployeeId').value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('voterName').value = '';
                showAlert('íˆ¬í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'íˆ¬í‘œ ì™„ë£Œ');
            } catch (error) {
                console.error("íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜:", error);
                showAlert(`íˆ¬í‘œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. <br><br>ì˜¤ë¥˜: ${error.message}`, "ì˜¤ë¥˜");
            }
        }

        // --- ê´€ë¦¬ì ë¡œì§ ---
        // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë° ë¡œê·¸ì¸
        async function checkAdminPassword() {
            if (!auth) return showAlert('Firebase ì¸ì¦ ì„œë¹„ìŠ¤ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'ì´ˆê¸°í™” ì¤‘');

            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            if (!email || !password) return showAlert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            
            try {
                // ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ ì‹œë„
                await signInWithEmailAndPassword(auth, email, password);
                hideModal('passwordModal'); // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ëª¨ë‹¬ ìˆ¨ê¹€
                showAlert('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ! ğŸ”“');
            } catch (error) {
                console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨ ìƒì„¸ ì •ë³´:", error);
                let errorDetails = `<b>ì˜¤ë¥˜ ì½”ë“œ:</b> ${error.code || 'ì •ì˜ë˜ì§€ ì•ŠìŒ'}<br><b>ì˜¤ë¥˜ ë©”ì‹œì§€:</b> ${error.message || 'ë©”ì‹œì§€ ì—†ìŒ'}`;
                showAlert(`ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì—¬ ì›ì¸ì„ íŒŒì•…í•´ì£¼ì„¸ìš”.<br><br>${errorDetails}`, 'ë¡œê·¸ì¸ ì˜¤ë¥˜');
            } finally {
                document.getElementById('adminPassword').value = ''; // ë¹„ë°€ë²ˆí˜¸ í•„ë“œ ì´ˆê¸°í™”
            }
        }

        // í”„ë¡œê·¸ë¨ ì¶”ê°€/ìˆ˜ì • í¼ ì œì¶œ ì²˜ë¦¬
        async function handleFormSubmit(e) {
            e.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë™ì‘ ë°©ì§€
            if (!isAdminMode || !db) return showAlert('ê´€ë¦¬ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ê±°ë‚˜, ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            
            const title = document.getElementById('programTitle').value.trim();
            const description = document.getElementById('programDescription').value.trim();
            const image = document.getElementById('programImage').value.trim();
            const videoUrl = document.getElementById('programVideo').value.trim(); // ë¹„ë””ì˜¤ URL ê°’ ì½ê¸°
            if (!title || !description || !image) return showAlert('í”„ë¡œê·¸ë¨ ì´ë¦„, ì„¤ëª…, ì´ë¯¸ì§€ URLì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
            
            const programsCollectionRef = collection(db, `artifacts/${appId}/public/data/programs`);
            const data = { title, description, image, videoUrl }; // ë°ì´í„° ê°ì²´ì— ë¹„ë””ì˜¤ URL í¬í•¨

            try {
                if (editingId) {
                    // í¸ì§‘ ëª¨ë“œì¼ ê²½ìš° ê¸°ì¡´ ë¬¸ì„œ ì—…ë°ì´íŠ¸
                    await updateDoc(doc(programsCollectionRef, editingId), data);
                    showAlert('í”„ë¡œê·¸ë¨ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    // ìƒˆ í”„ë¡œê·¸ë¨ ì¶”ê°€ ëª¨ë“œì¼ ê²½ìš°
                    const maxOrder = programs.reduce((max, p) => Math.max(max, p.order || 0), 0);
                    // ìƒˆ ë¬¸ì„œ ì¶”ê°€ (íˆ¬í‘œ ìˆ˜, íˆ¬í‘œì ëª©ë¡ ì´ˆê¸°í™” ë° ìˆœì„œ ë¶€ì—¬)
                    await addDoc(programsCollectionRef, { ...data, votes: 0, voters: [], order: maxOrder + 1 });
                    showAlert('ìƒˆë¡œìš´ í”„ë¡œê·¸ë¨ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                clearForm(); // í¼ ì´ˆê¸°í™”
            } catch (error) {
                console.error("í”„ë¡œê·¸ë¨ ì¶”ê°€/ìˆ˜ì • ì˜¤ë¥˜:", error);
                showAlert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>(ì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message})`);
            }
        }
        
        // í¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        function clearForm() {
            programForm.reset(); // í¼ ë¦¬ì…‹
            editingId = null; // í¸ì§‘ ID ì´ˆê¸°í™”
            document.querySelector('#programForm button[type="submit"]').textContent = 'í”„ë¡œê·¸ë¨ ì¶”ê°€'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        }

        // í”„ë¡œê·¸ë¨ í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
        window.editProgram = (id) => {
            if (!isAdminMode) return; // ê´€ë¦¬ì ëª¨ë“œê°€ ì•„ë‹ˆë©´ ì¢…ë£Œ
            const p = programs.find(prog => prog.id === id); // í•´ë‹¹ IDì˜ í”„ë¡œê·¸ë¨ ì°¾ê¸°
            if (p) {
                // í¼ í•„ë“œì— í”„ë¡œê·¸ë¨ ë°ì´í„° ì±„ìš°ê¸°
                document.getElementById('programTitle').value = p.title;
                document.getElementById('programDescription').value = p.description.replace(/<br\s*\/?>/gi, '\n'); // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
                document.getElementById('programImage').value = p.image || '';
                document.getElementById('programVideo').value = p.videoUrl || '';
                editingId = id; // í¸ì§‘ ID ì„¤ì •
                document.querySelector('#programForm button[type="submit"]').textContent = 'í”„ë¡œê·¸ë¨ ìˆ˜ì •'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' }); // ê´€ë¦¬ì íŒ¨ë„ë¡œ ìŠ¤í¬ë¡¤
            }
        };

        // í”„ë¡œê·¸ë¨ ì‚­ì œ
        window.deleteProgram = async (id) => {
            if (!isAdminMode || !db) return; // ê´€ë¦¬ì ëª¨ë“œê°€ ì•„ë‹ˆê±°ë‚˜ DBê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¢…ë£Œ
            const confirmed = await showConfirm('ì •ë§ë¡œ ì´ í”„ë¡œê·¸ë¨ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? íˆ¬í‘œ ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.', 'ì‚­ì œ í™•ì¸');
            if (confirmed) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/programs`, id)); // ë¬¸ì„œ ì‚­ì œ
                    showAlert('í”„ë¡œê·¸ë¨ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
                    showAlert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            }
        };
        
        // íŠ¹ì • í”„ë¡œê·¸ë¨ì˜ íˆ¬í‘œì ëª…ë‹¨ í‘œì‹œ
        window.showVoters = (id) => { 
            if (!isAdminMode) return; // ê´€ë¦¬ì ëª¨ë“œê°€ ì•„ë‹ˆë©´ ì¢…ë£Œ
            const p = programs.find(p => p.id === id); // í•´ë‹¹ IDì˜ í”„ë¡œê·¸ë¨ ì°¾ê¸°
            if (!p) return; 
            const voterListEl = document.getElementById('voterList'); 
            document.getElementById('voterListTitle').textContent = `[${p.title}] íˆ¬í‘œì ëª…ë‹¨`; 
            const voters = p.voters || []; // íˆ¬í‘œì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            // íˆ¬í‘œì ëª©ë¡ì„ HTML ë¦¬ìŠ¤íŠ¸ë¡œ ìƒì„±
            voterListEl.innerHTML = voters.length ? voters.map(v => `<li>${v.name} (${v.id})</li>`).join('') : '<li>ì•„ì§ íˆ¬í‘œí•œ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</li>'; 
            showModal('voterListModal'); // íˆ¬í‘œì ëª…ë‹¨ ëª¨ë‹¬ í‘œì‹œ
        };

        // DB ì´ˆê¸°í™” ë° ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì„¤ì •
        async function runInitialization() {
            if (!isAdminMode || !db) return showAlert('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•´ì•¼ í•˜ê±°ë‚˜, ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            
            // ì‚¬ìš©ìì—ê²Œ ì´ˆê¸°í™” í™•ì¸ ìš”ì²­
            const confirmed = await showConfirm("ğŸš¨ì •ë§ë¡œ ëª¨ë“  íˆ¬í‘œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ê¸°ë³¸ í”„ë¡œê·¸ë¨ìœ¼ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!", "DB ì´ˆê¸°í™” í™•ì¸");
            if (!confirmed) return showAlert('ì´ˆê¸°í™”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');

            try {
                showAlert('DB ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...');
                const programsCollectionRef = collection(db, `artifacts/${appId}/public/data/programs`);
                
                // ê¸°ì¡´ ëª¨ë“  ë¬¸ì„œ ì‚­ì œ
                const oldDocsSnapshot = await getDocs(query(programsCollectionRef));
                const deleteBatch = writeBatch(db);
                oldDocsSnapshot.forEach(doc => deleteBatch.delete(doc.ref));
                await deleteBatch.commit();
                
                // ê¸°ë³¸ í”„ë¡œê·¸ë¨ ë°ì´í„° ì •ì˜ (videoUrl í•„ë“œ í¬í•¨)
                const defaultPrograms = [
                    { order: 1, title: 'ğŸš£ ë˜í”„íŒ…', description: 'ì—´ëŒ€ìš°ë¦¼, ë©‹ì§„ í­í¬, ê¹ì•„ì§€ë¥¸ í˜‘ê³¡<br>ë©‹ì§„ í’ê²½ì´ í¼ì³ì§„ ì•„ìœµê°•ì—ì„œ<br>ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ë˜í”„íŒ…ì„ ì¦ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 3ì‹œê°„<br>ì´ìš©ì‹œê°„ : ì•½ 2ì‹œê°„', image: 'https://images.unsplash.com/photo-1624646580989-9f059e25eb78?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/program1.mp4' },
                    { order: 2, title: 'ğŸŒ¿ ë°œë¦¬ìŠ¤ìœ™', description: 'ë°œë¦¬ì˜ í™˜ìƒì ì¸ ì •ê¸€ ì†ì—ì„œ<br>ìœ ëª…í•œ ìŠ¤ìœ™ì„ ì¦ê¸°ë©°<br>ì´êµ­ì ì¸ í’ê²½ê³¼ ì¸ìƒ ì‚¬ì§„ì„ ë‚¨ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 3ì‹œê°„<br>ì´ìš©ì‹œê°„ : ì•½ 2ì‹œê°„', image: 'https://images.unsplash.com/photo-1708436137498-1b660e94c782?q=80&w=687&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: '' },
                    { order: 3, title: 'ğŸ–ï¸ ë¦¬ì¡°íŠ¸ ììœ ì‹œê°„', description: 'ê³ ê¸‰ ë¦¬ì¡°íŠ¸ì˜ ìˆ˜ì˜ì¥ê³¼ ë¶€ëŒ€ì‹œì„¤ì„<br>ë§ˆìŒê» ì´ìš©í•˜ë©° ëˆ„êµ¬ì˜ ë°©í•´ë„ ë°›ì§€ ì•ŠëŠ”<br>ì™„ë²½í•œ ììœ ì‹œê°„ì„ ë§Œë½í•©ë‹ˆë‹¤.<br>ì´ë™ì‹œê°„ : ì—†ìŒ<br>ì´ìš©ì‹œê°„ : ì—†ìŒ', image: 'https://images.unsplash.com/photo-1596178065887-1198b6148b2b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80', videoUrl: '' },
                    { order: 4, title: 'ğŸŒï¸â€â™‚ï¸ ê³¨í”„', description: 'ë°œë¦¬ ë‰´ ê¾¸ë”° ê³¨í”„ í´ëŸ½ì—ì„œ<br>í™˜ìƒì ì¸ í•´ì•ˆì ˆê²½ì„ ê°ìƒí•˜ë©°<br>ìƒ‰ë‹¤ë¥¸ ë¼ìš´ë”©ì„ ì¦ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 1ì‹œê°„<br>ì´ìš©ì‹œê°„ : ì•½ 3ì‹œê°„', image: 'https://images.unsplash.com/photo-1535131749006-b7f58c99034b?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/program4.mp4' },
                    { order: 5, title: 'ğŸš¤ ìš¸ë£¨ì™€ëšœ + ë”°ë‚˜ë°”ë½', description: 'ê²½ì´ë¡œìš´ ìì—°ê³¼ íŒë‘-ìë°” ì—­ì‚¬<br>ë…íŠ¹í•œ ê±´ì¶•ë¬¼ì´ ì–´ìš°ëŸ¬ì§„ ìš¸ë£¨ì™€íˆ¬ì™€<br>ì¸ìƒìƒ· ëª…ì†Œ ë”°ë‚˜ë°”ë½ ì ˆë²½ì„ ì°¾ì•„ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 1ì‹œê°„<br>ì´ìš©ì‹œê°„ : ì•½ 3ì‹œê°„', image: 'https://images.unsplash.com/photo-1664922114319-4700c0ef74b1?q=80&w=1074&auto=format&fit&crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: '' },
                    { order: 6, title: 'ğŸ¢ ì›Œí„°ë´„ ë°œë¦¬', description: 'ë°œë¦¬ ê¾¸ë”°ì— ìœ„ì¹˜í•œ ì¸ê¸° ì›Œí„°íŒŒí¬ì…ë‹ˆë‹¤.<br>ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ì›Œí„°ìŠ¬ë¼ì´ë“œì™€ ì–´íŠ¸ë™ì…˜<br>ë‹¤ì–‘í•œ í¸ì˜ì‹œì„¤ì„ í•¨ê»˜ ì¦ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 1ì‹œê°„<br>ì´ìš©ì‹œê°„ : ì•½ 3ì‹œê°„', image: 'https://images.unsplash.com/photo-1741316041430-4e5362625ff2?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/program5.mp4' }
                ];
                
                // ê¸°ë³¸ í”„ë¡œê·¸ë¨ë“¤ì„ ì¼ê´„ ì¶”ê°€
                const addBatch = writeBatch(db);
                defaultPrograms.forEach(program => {
                    const newProgramRef = doc(programsCollectionRef);
                    addBatch.set(newProgramRef, { ...program, votes: 0, voters: [] });
                });
                await addBatch.commit();
                
                showAlert('ì´ˆê¸° ë°ì´í„° ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error("DB ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                showAlert(`DB ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.<br>ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)
        async function addDefaultPrograms() {
            if (!isAdminMode || !db) return showAlert('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•´ì•¼ í•˜ê±°ë‚˜, ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');

            const confirmed = await showConfirm("ê¸°ë³¸ í”„ë¡œê·¸ë¨ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? <br>ì´ë¯¸ ëª©ë¡ì— ìˆëŠ” í”„ë¡œê·¸ë¨ì€ ì¤‘ë³µìœ¼ë¡œ ì¶”ê°€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€");
            if (!confirmed) return;

            try {
                showAlert('ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');
                const programsCollectionRef = collection(db, `artifacts/${appId}/public/data/programs`);

                // í˜„ì¬ DBì— ìˆëŠ” í”„ë¡œê·¸ë¨ë“¤ì˜ order ê°’ì„ ê°€ì ¸ì˜´
                const existingProgramsSnapshot = await getDocs(query(programsCollectionRef));
                const existingOrders = new Set(existingProgramsSnapshot.docs.map(doc => doc.data().order));

                // ê¸°ë³¸ í”„ë¡œê·¸ë¨ ë°ì´í„° ì •ì˜ (videoUrl í•„ë“œ í¬í•¨)
                const defaultPrograms = [
                    { order: 1, title: 'ğŸš£ ë˜í”„íŒ…', description: 'ì—´ëŒ€ìš°ë¦¼, ë©‹ì§„ í­í¬, ê¹ì•„ì§€ë¥¸ í˜‘ê³¡<br>ë©‹ì§„ í’ê²½ì´ í¼ì³ì§„ ì•„ìœµê°•ì—ì„œ<br>ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ë˜í”„íŒ…ì„ ì¦ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 3ì‹œê°„<br>ì´ìš©ì‹œê°„ : ì•½ 2ì‹œê°„', image: 'https://images.unsplash.com/photo-1624646580989-9f059e25eb78?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/program1.mp4' },
                    { order: 2, title: 'ğŸŒ¿ ë°œë¦¬ìŠ¤ìœ™', description: 'ë°œë¦¬ì˜ í™˜ìƒì ì¸ ì •ê¸€ ì†ì—ì„œ<br>ìœ ëª…í•œ ìŠ¤ìœ™ì„ ì¦ê¸°ë©°<br>ì´êµ­ì ì¸ í’ê²½ê³¼ ì¸ìƒ ì‚¬ì§„ì„ ë‚¨ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 3ì‹œê°„<br>ì´ìš©ì‹œê°„ : ì•½ 2ì‹œê°„', image: 'https://images.unsplash.com/photo-1708436137498-1b660e94c782?q=80&w=687&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: '' },
                    { order: 3, title: 'ğŸ–ï¸ ë¦¬ì¡°íŠ¸ ììœ ì‹œê°„', description: 'ê³ ê¸‰ ë¦¬ì¡°íŠ¸ì˜ ìˆ˜ì˜ì¥ê³¼ ë¶€ëŒ€ì‹œì„¤ì„<br>ë§ˆìŒê» ì´ìš©í•˜ë©° ëˆ„êµ¬ì˜ ë°©í•´ë„ ë°›ì§€ ì•ŠëŠ”<br>ì™„ë²½í•œ ììœ ì‹œê°„ì„ ë§Œë½í•©ë‹ˆë‹¤.<br>ì´ë™ì‹œê°„ : ì—†ìŒ<br>ì´ìš©ì‹œê°„ : ì—†ìŒ', image: 'https://images.unsplash.com/photo-1596178065887-1198b6148b2b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80', videoUrl: '' },
                    { order: 4, title: 'ğŸŒï¸â€â™‚ï¸ ê³¨í”„', description: 'ë°œë¦¬ ë‰´ ê¾¸ë”° ê³¨í”„ í´ëŸ½ì—ì„œ<br>í™˜ìƒì ì¸ í•´ì•ˆì ˆê²½ì„ ê°ìƒí•˜ë©°<br>ìƒ‰ë‹¤ë¥¸ ë¼ìš´ë”©ì„ ì¦ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 1ì‹œê°„<br>ì´ìš©ì‹œê°„ : ì•½ 3ì‹œê°„', image: 'https://images.unsplash.com/photo-1535131749006-b7f58c99034b?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/program4.mp4' },
                    { order: 5, title: 'ğŸš¤ ìš¸ë£¨ì™€ëšœ + ë”°ë‚˜ë°”ë½', description: 'ê²½ì´ë¡œìš´ ìì—°ê³¼ íŒë‘-ìë°” ì—­ì‚¬<br>ë…íŠ¹í•œ ê±´ì¶•ë¬¼ì´ ì–´ìš°ëŸ¬ì§„ ìš¸ë£¨ì™€íˆ¬ì™€<br>ì¸ìƒìƒ· ëª…ì†Œ ë”°ë‚˜ë°”ë½ ì ˆë²½ì„ ì°¾ì•„ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 1ì‹œê°„<br>ì´ìš©ì‹œê°„ : ì•½ 3ì‹œê°„', image: 'https://images.unsplash.com/photo-1664922114319-4700c0ef74b1?q=80&w=1074&auto=format&fit&crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: '' },
                    { order: 6, title: 'ğŸ¢ ì›Œí„°ë´„ ë°œë¦¬', description: 'ë°œë¦¬ ê¾¸ë”°ì— ìœ„ì¹˜í•œ ì¸ê¸° ì›Œí„°íŒŒí¬ì…ë‹ˆë‹¤.<br>ìŠ¤ë¦´ ë„˜ì¹˜ëŠ” ì›Œí„°ìŠ¬ë¼ì´ë“œì™€ ì–´íŠ¸ë™ì…˜<br>ë‹¤ì–‘í•œ í¸ì˜ì‹œì„¤ì„ í•¨ê»˜ ì¦ê²¨ë³´ì„¸ìš”.<br>ì´ë™ì‹œê°„ : í¸ë„ ì•½ 1ì‹œê°„<br>ì´ìš©ì‹œê°„ : ì•½ 3ì‹œê°„', image: 'https://images.unsplash.com/photo-1741316041430-4e5362625ff2?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D', videoUrl: 'https://raw.githubusercontent.com/incarmarketing/bali-vote-project/main/program5.mp4' }
                ];

                // ê¸°ì¡´ order ê°’ê³¼ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” í”„ë¡œê·¸ë¨ë§Œ í•„í„°ë§
                const programsToAdd = defaultPrograms.filter(p => !existingOrders.has(p.order));

                if (programsToAdd.length === 0) {
                    showAlert('ëª¨ë“  ê¸°ë³¸ í”„ë¡œê·¸ë¨ì´ ì´ë¯¸ ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.', 'ì•Œë¦¼');
                    return;
                }

                // í•„í„°ë§ëœ í”„ë¡œê·¸ë¨ë“¤ì„ ì¼ê´„ ì¶”ê°€
                const addBatch = writeBatch(db);
                programsToAdd.forEach(program => {
                    const newProgramRef = doc(programsCollectionRef);
                    addBatch.set(newProgramRef, { ...program, votes: 0, voters: [] });
                });
                await addBatch.commit();

                showAlert(`${programsToAdd.length}ê°œì˜ ê¸°ë³¸ í”„ë¡œê·¸ë¨ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'ì¶”ê°€ ì™„ë£Œ');
            } catch (error) {
                console.error("ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                showAlert(`ê¸°ë³¸ í”„ë¡œê·¸ë¨ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // íˆ¬í‘œ ê²°ê³¼ë¥¼ ì—‘ì…€(CSV) íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
        function exportToExcel() {
            if (!isAdminMode) return showAlert('ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
            if (programs.length === 0) return showAlert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            
            showAlert('ëª¨ë“  íˆ¬í‘œì ì •ë³´ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤...');
            const allVoters = [];
            // ëª¨ë“  í”„ë¡œê·¸ë¨ì˜ íˆ¬í‘œì ì •ë³´ë¥¼ ìˆ˜ì§‘
            programs.forEach(p => {
                if (p.voters?.length) {
                    p.voters.forEach(v => allVoters.push({ program: p.title.replace(/,/g, ''), id: v.id, name: v.name }));
                }
            });
            
            if (!allVoters.length) return showAlert('ë‹¤ìš´ë¡œë“œí•  íˆ¬í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            
            // CSV í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ìƒì„± (UTF-8 BOM í¬í•¨í•˜ì—¬ í•œê¸€ ê¹¨ì§ ë°©ì§€)
            const csv = `${"\uFEFF"}"í”„ë¡œê·¸ë¨","ì‚¬ë²ˆ","ì´ë¦„"\n${allVoters.map(v => `"${v.program}","${v.id}","${v.name}"`).join('\n')}`;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "bali_vote_results.csv";
            document.body.appendChild(link);
            link.click(); // ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
            document.body.removeChild(link); // ë§í¬ ì œê±°
        }

    </script>
</body>
</html>
